const canvas=document.getElementById("simCanvas"),container=document.getElementById("sim-container"),ctx=canvas.getContext("2d"),CONFIG={gridSize:30,scale:500,wireRadius:18,forceScale:200};let wires=[],mouse={x:-100,y:-100},isDragging=!1,selectedIdx=-1,nextId=1;function resize(){canvas.width=container.offsetWidth,canvas.height=container.offsetHeight,draw()}function getMousePos(e){let t=canvas.getBoundingClientRect();return{x:e.clientX-t.left,y:e.clientY-t.top}}function updateUI(){let e=parseInt(document.getElementById("current-slider").value),t=document.getElementById("current-display");e>0?(t.innerHTML=`+${e}.0 A <span class="text-amber-500">(OUT ⊙)</span>`,t.className="font-mono text-xs font-bold text-amber-400"):e<0?(t.innerHTML=`${e}.0 A <span class="text-sky-400">(IN ⊗)</span>`,t.className="font-mono text-xs font-bold text-sky-400"):(t.innerHTML='0.0 A <span class="text-slate-500">(OFF)</span>',t.className="font-mono text-xs font-bold text-slate-500"),-1!==selectedIdx&&(wires[selectedIdx].i=e,draw())}function spawnWire(){let e=parseInt(document.getElementById("current-slider").value);wires.push({id:nextId++,x:canvas.width/2+(Math.random()-.5)*100,y:canvas.height/2+(Math.random()-.5)*100,i:0===e?5:e}),draw()}function resetSim(){wires=[],selectedIdx=-1,draw()}function calculateB(e,t){let i=0,c=0;for(let a of wires){let n=e-a.x,s=t-a.y,r=n*n+s*s,l=Math.sqrt(r);if(l<CONFIG.wireRadius)continue;let o=a.i*CONFIG.scale/r;i+=-s*o,c+=n*o}return{x:i,y:c}}function draw(){ctx.fillStyle="#020617",ctx.fillRect(0,0,canvas.width,canvas.height);let e=document.querySelector('input[name="viewMode"]:checked').value,t=document.getElementById("show-forces").checked,i=document.getElementById("show-compass").checked;wires.length>0&&("vectors"===e?drawVectorGrid():"iron"===e?drawIronFilings():"lines"===e&&drawStreamlines()),t&&drawLorentzForces();for(let c=0;c<wires.length;c++)drawCopperWire(wires[c],c===selectedIdx);i&&drawMouseCompass()}function drawCopperWire(e,t){ctx.save(),ctx.translate(e.x,e.y),t&&(ctx.beginPath(),ctx.arc(0,0,CONFIG.wireRadius+6,0,2*Math.PI),ctx.strokeStyle="white",ctx.lineWidth=2,ctx.setLineDash([4,4]),ctx.stroke());let i=ctx.createRadialGradient(-5,-5,2,0,0,CONFIG.wireRadius);i.addColorStop(0,"#fdba74"),i.addColorStop(.5,"#b45309"),i.addColorStop(1,"#451a03"),ctx.beginPath(),ctx.arc(0,0,CONFIG.wireRadius,0,2*Math.PI),ctx.fillStyle=i,ctx.fill(),ctx.beginPath(),ctx.arc(0,0,CONFIG.wireRadius,0,2*Math.PI),ctx.strokeStyle=e.i>0?"#fbbf24":e.i<0?"#38bdf8":"#64748b",ctx.lineWidth=3,ctx.stroke(),ctx.fillStyle="white",e.i>0?(ctx.beginPath(),ctx.arc(0,0,4,0,2*Math.PI),ctx.fill()):e.i<0&&(ctx.lineWidth=3,ctx.strokeStyle="white",ctx.beginPath(),ctx.moveTo(-6,-6),ctx.lineTo(6,6),ctx.moveTo(6,-6),ctx.lineTo(-6,6),ctx.stroke()),ctx.restore()}function drawVectorGrid(){ctx.beginPath();for(let e=0;e<canvas.width;e+=CONFIG.gridSize)for(let t=0;t<canvas.height;t+=CONFIG.gridSize){let i=calculateB(e,t),c=Math.hypot(i.x,i.y);if(c>.05){let a=Math.atan2(i.y,i.x),n=Math.min(.8*CONFIG.gridSize,15*c),s=Math.min(1,.8*c);ctx.strokeStyle=`rgba(56, 189, 248, ${s})`,drawArrow(e,t,a,n)}}ctx.stroke()}function drawIronFilings(){ctx.strokeStyle="rgba(148, 163, 184, 0.4)",ctx.lineWidth=1,ctx.beginPath();for(let e=0;e<1500;e++){let t=Math.random()*canvas.width,i=Math.random()*canvas.height,c=calculateB(t,i),a=Math.hypot(c.x,c.y);if(a>.02){let n=Math.atan2(c.y,c.x),s=6*Math.cos(n)/2,r=6*Math.sin(n)/2;ctx.moveTo(t-s,i-r),ctx.lineTo(t+s,i+r)}}ctx.stroke()}function drawStreamlines(){ctx.strokeStyle="rgba(56, 189, 248, 0.2)",ctx.lineWidth=1;for(let e=0;e<canvas.width;e+=60)for(let t=0;t<canvas.height;t+=60){let i=calculateB(e,t);if(.05>Math.hypot(i.x,i.y))continue;ctx.beginPath();let c=e,a=t;ctx.moveTo(c,a);for(let n=0;n<25;n++){let s=calculateB(c,a),r=Math.hypot(s.x,s.y);if(r<.01)break;c+=s.x/r*10,a+=s.y/r*10,ctx.lineTo(c,a)}ctx.stroke()}}function drawLorentzForces(){wires.forEach((e,t)=>{let i=0,c=0;wires.forEach((a,n)=>{if(t===n)return;let s=a.x-e.x,r=a.y-e.y,l=CONFIG.forceScale*Math.abs(e.i*a.i)/Math.hypot(s,r),o=e.i*a.i>0,x=Math.atan2(r,s),d=o?x:x+Math.PI;i+=Math.cos(d)*l,c+=Math.sin(d)*l});let a=Math.hypot(i,c);if(a>1){let n=Math.atan2(c,i),s=Math.min(100,a);ctx.save(),ctx.translate(e.x,e.y),ctx.rotate(n),ctx.beginPath(),ctx.strokeStyle="#f43f5e",ctx.lineWidth=4,ctx.moveTo(CONFIG.wireRadius+5,0),ctx.lineTo(CONFIG.wireRadius+5+s,0),ctx.stroke(),ctx.fillStyle="#f43f5e",ctx.beginPath();let r=CONFIG.wireRadius+5+s;ctx.moveTo(r,0),ctx.lineTo(r-10,-5),ctx.lineTo(r-10,5),ctx.fill(),ctx.fillStyle="#fff",ctx.font="bold 12px sans-serif",ctx.rotate(-n),ctx.fillText("F",15,-25),ctx.restore()}})}function drawMouseCompass(){let e=calculateB(mouse.x,mouse.y),t=Math.hypot(e.x,e.y),i=t>.001?Math.atan2(e.y,e.x):-Math.PI/2;ctx.save(),ctx.translate(mouse.x,mouse.y),ctx.beginPath(),ctx.arc(0,0,20,0,2*Math.PI),ctx.fillStyle="rgba(15, 23, 42, 0.8)",ctx.strokeStyle="#fff",ctx.lineWidth=2,ctx.fill(),ctx.stroke(),ctx.rotate(i),ctx.beginPath(),ctx.fillStyle="#ef4444",ctx.moveTo(0,-4),ctx.lineTo(14,0),ctx.lineTo(0,4),ctx.fill(),ctx.beginPath(),ctx.fillStyle="#fff",ctx.moveTo(0,-4),ctx.lineTo(-14,0),ctx.lineTo(0,4),ctx.fill(),ctx.beginPath(),ctx.arc(0,0,2,0,2*Math.PI),ctx.fillStyle="#0f172a",ctx.fill(),ctx.restore()}function drawArrow(e,t,i,c){ctx.save(),ctx.translate(e,t),ctx.rotate(i),ctx.moveTo(-c/2,0),ctx.lineTo(c/2,0),ctx.lineTo(c/2-3,-2),ctx.moveTo(c/2,0),ctx.lineTo(c/2-3,2),ctx.restore()}window.addEventListener("resize",resize),window.addEventListener("load",()=>{resize(),wires.push({id:nextId++,x:canvas.width/2-120,y:canvas.height/2,i:5}),wires.push({id:nextId++,x:canvas.width/2+120,y:canvas.height/2,i:5}),updateUI(),draw()}),canvas.addEventListener("mousemove",e=>{let t=getMousePos(e);mouse.x=t.x,mouse.y=t.y,isDragging&&-1!==selectedIdx&&(wires[selectedIdx].x=mouse.x,wires[selectedIdx].y=mouse.y),draw()}),canvas.addEventListener("mousedown",e=>{let t=getMousePos(e),i=-1;for(let c=wires.length-1;c>=0;c--){let a=Math.hypot(wires[c].x-t.x,wires[c].y-t.y);if(a<1.5*CONFIG.wireRadius){i=c;break}}-1!==i?(isDragging=!0,selectedIdx=i,document.getElementById("current-slider").value=wires[i].i,updateUI()):selectedIdx=-1,draw()}),canvas.addEventListener("mouseup",()=>{isDragging=!1}),canvas.addEventListener("dblclick",e=>{let t=getMousePos(e);for(let i=wires.length-1;i>=0;i--){let c=Math.hypot(wires[i].x-t.x,wires[i].y-t.y);if(c<1.5*CONFIG.wireRadius){wires.splice(i,1),selectedIdx=-1,draw();break}}});