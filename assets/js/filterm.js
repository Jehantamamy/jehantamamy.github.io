let chart,time=0,smaBuffer=[],lastEma=0,smaErrorSum=0,emaErrorSum=0,sampleCount=0;function initChart(){let e=document.getElementById("filterChart").getContext("2d");chart=new Chart(e,{type:"line",data:{labels:[],datasets:[{label:"Raw Sensor (Noisy)",data:[],borderColor:"#f43f5e",borderWidth:1,pointRadius:0,tension:.1},{label:"SMA Filtered",data:[],borderColor:"#0ea5e9",borderWidth:2,pointRadius:0,tension:.3},{label:"EMA Filtered",data:[],borderColor:"#a855f7",borderWidth:2,pointRadius:0,tension:.3}]},options:{responsive:!0,maintainAspectRatio:!1,animation:!1,interaction:{intersect:!1},scales:{y:{min:0,max:100,grid:{color:"#f1f5f9"}},x:{display:!1}},plugins:{legend:{labels:{font:{size:10,family:"Inter"},usePointStyle:!0}}}}})}function simulate(){let e=parseFloat(document.getElementById("noise-lvl").value),a=parseInt(document.getElementById("sma-window").value),t=parseFloat(document.getElementById("ema-alpha").value);document.getElementById("noise-val").innerText=e,document.getElementById("sma-val").innerText=a,document.getElementById("ema-val").innerText=t.toFixed(2);let r=50+30*Math.sin(.1*time),l=r+(Math.random()-.5)*e*2;smaBuffer.push(l),smaBuffer.length>a&&smaBuffer.shift();let n=smaBuffer.reduce((e,a)=>e+a,0)/smaBuffer.length;0===time&&(lastEma=l);let i=t*l+(1-t)*lastEma;lastEma=i,smaErrorSum+=Math.pow(n-r,2),emaErrorSum+=Math.pow(i-r,2),++sampleCount%5==0&&(document.getElementById("sma-rmse").innerText=Math.sqrt(smaErrorSum/sampleCount).toFixed(2),document.getElementById("ema-rmse").innerText=Math.sqrt(emaErrorSum/sampleCount).toFixed(2)),chart.data.labels.push(time.toFixed(1)),chart.data.datasets[0].data.push(l),chart.data.datasets[1].data.push(n),chart.data.datasets[2].data.push(i),chart.data.labels.length>100&&(chart.data.labels.shift(),chart.data.datasets[0].data.shift(),chart.data.datasets[1].data.shift(),chart.data.datasets[2].data.shift()),chart.update("none"),time+=1}function resetData(){time=0,smaBuffer=[],lastEma=0,smaErrorSum=0,emaErrorSum=0,sampleCount=0,document.getElementById("sma-rmse").innerText="0.00",document.getElementById("ema-rmse").innerText="0.00",chart.data.labels=[],chart.data.datasets.forEach(e=>e.data=[]),chart.update()}function updateGeneratedCode(){let e=document.getElementById("sma-window").value,a=document.getElementById("ema-alpha").value,t=`
/* * Generated by Aries Tech - Filter Lab
 * Parameters: SMA Window=${e}, EMA Alpha=${a}
 */

// === OPSI 1: EMA Filter (Direkomendasikan: Irit Memori) ===
float emaAlpha = ${a};
float lastEMA = 0;

float applyEMA(float rawData) {
    float filtered = (emaAlpha * rawData) + ((1.0 - emaAlpha) * lastEMA);
    lastEMA = filtered;
    return filtered;
}

// === OPSI 2: SMA Filter (Butuh Array Memori) ===
const int WINDOW_SIZE = ${e};
float readings[WINDOW_SIZE];
int readIndex = 0;
float total = 0;
float average = 0;

float applySMA(float rawData) {
    total = total - readings[readIndex]; // Kurangi data lama
    readings[readIndex] = rawData;       // Simpan data baru
    total = total + readings[readIndex]; // Tambah data baru
    readIndex = (readIndex + 1) % WINDOW_SIZE; // Geser index
    
    average = total / WINDOW_SIZE;
    return average;
}

void setup() {
    Serial.begin(9600);
    // Inisialisasi array SMA dengan 0
    for (int i = 0; i < WINDOW_SIZE; i++) readings[i] = 0;
}

void loop() {
    // Contoh pembacaan sensor
    float sensorValue = analogRead(A0); 
    
    // Pilih salah satu filter:
    float hasilFilter = applyEMA(sensorValue); 
    
    Serial.print("Raw:");
    Serial.print(sensorValue);
    Serial.print(",Filtered:");
    Serial.println(hasilFilter);
    
    delay(10); // Sampling rate
}
        `.trim();document.getElementById("code-output").innerText=t}function copyCode(){let e=document.getElementById("code-output").innerText;navigator.clipboard.writeText(e).then(()=>{alert("Kode C++ berhasil disalin ke clipboard!")})}document.querySelectorAll("input[type=range]").forEach(e=>{e.addEventListener("input",updateGeneratedCode)}),document.querySelectorAll("input[type=range]").forEach(e=>{e.addEventListener("change",()=>{})}),window.onload=function(){initChart(),updateGeneratedCode(),setInterval(simulate,50)};