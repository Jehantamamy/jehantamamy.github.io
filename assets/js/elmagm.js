const canvas=document.getElementById("simCanvas"),ctx=canvas.getContext("2d"),monitorEl=document.getElementById("data-monitor"),PIXEL_SCALE=100,K_CONST=9e9,GRID_SIZE=40;let charges=[],isDragging=!1,selectedIdx=-1,nextId=1;function resize(){canvas.width=canvas.parentElement.offsetWidth,canvas.height=canvas.parentElement.offsetHeight,draw()}function updateSliderUI(e){let t=parseFloat(e);document.getElementById("charge-val-display").innerText=`${t>0?"+":""}${t.toFixed(1)} \xb5C`;let a=document.getElementById("btn-spawn");t>0?a.className=a.className.replace(/bg-\w+-600/,"bg-red-600").replace(/hover:bg-\w+-500/,"hover:bg-red-500").replace(/shadow-\w+-500/,"shadow-red-500"):t<0?a.className=a.className.replace(/bg-\w+-600/,"bg-blue-600").replace(/hover:bg-\w+-500/,"hover:bg-blue-500").replace(/shadow-\w+-500/,"shadow-blue-500"):a.className=a.className.replace(/bg-\w+-600/,"bg-slate-600").replace(/hover:bg-\w+-500/,"hover:bg-slate-500").replace(/shadow-\w+-500/,"shadow-slate-500")}function spawnCharge(){let e=parseFloat(document.getElementById("charge-slider").value);0!==e&&(charges.push({id:nextId++,x:canvas.width/2+(Math.random()-.5)*50,y:canvas.height/2+(Math.random()-.5)*50,q:e}),draw())}function resetSim(){charges=[],selectedIdx=-1,monitorEl.classList.add("opacity-0","translate-y-4"),draw()}function getMousePos(e){let t=canvas.getBoundingClientRect();return{x:e.clientX-t.left,y:e.clientY-t.top}}function draw(){ctx.fillStyle="#020617",ctx.fillRect(0,0,canvas.width,canvas.height);let e=document.getElementById("show-vectors").checked,t=document.getElementById("show-ruler").checked,a=document.getElementById("show-forces").checked;if(e&&charges.length>0){ctx.beginPath();for(let l=0;l<canvas.width;l+=40)for(let c=0;c<canvas.height;c+=40){let s=0,n=0;for(let r of charges){let i=l-r.x,o=c-r.y,d=i*i+o*o,x=Math.sqrt(d);if(x<15)continue;let $=500*r.q/d;s+=$*(i/x),n+=$*(o/x)}let h=Math.hypot(s,n);if(h>.1){let g=Math.atan2(n,s),f=Math.min(1,h),y=Math.min(20,15*h);ctx.strokeStyle=`rgba(255,255,255,${.4*f})`,drawArrow(l,c,g,y)}}ctx.stroke()}if(-1!==selectedIdx&&charges[selectedIdx]){let _=charges[selectedIdx],m=0,w=0;for(let v=0;v<charges.length;v++){if(v===selectedIdx)continue;let p=charges[v],b=p.x-_.x,u=p.y-_.y,I=Math.hypot(b,u),E=.001*I;if(t){ctx.save(),ctx.beginPath(),ctx.setLineDash([5,5]),ctx.strokeStyle="#10b981",ctx.lineWidth=1,ctx.moveTo(_.x,_.y),ctx.lineTo(p.x,p.y),ctx.stroke();let q=(_.x+p.x)/2,T=(_.y+p.y)/2;ctx.fillStyle="#10b981",ctx.font="10px monospace",ctx.globalAlpha=1;let S=E<1?`${(100*E).toFixed(1)} cm`:`${E.toFixed(2)} m`;ctx.fillStyle="rgba(2, 6, 23, 0.8)";let B=ctx.measureText(S);ctx.fillRect(q-B.width/2-2,T-6,B.width+4,12),ctx.fillStyle="#10b981",ctx.fillText(S,q-B.width/2,T+3),ctx.restore()}let L=1e-6*_.q,P=1e-6*p.q,k=9e9*Math.abs(L*P)/(E*E),C=_.q*p.q>0,N=Math.atan2(u,b),D=C?N+Math.PI:N;m+=k*Math.cos(D),w+=k*Math.sin(D)}if(a){let M=Math.hypot(m,w);if(M>.01){let F=Math.atan2(w,m),A=Math.min(100,150*Math.log10(M+1));ctx.save(),ctx.translate(_.x,_.y),ctx.rotate(F),ctx.beginPath(),ctx.strokeStyle="white",ctx.fillStyle="white",ctx.lineWidth=3,ctx.moveTo(0,0),ctx.lineTo(A,0),ctx.stroke(),ctx.beginPath(),ctx.moveTo(A,0),ctx.lineTo(A-8,-4),ctx.lineTo(A-8,4),ctx.fill(),ctx.rotate(-F),ctx.fillStyle="#f43f5e",ctx.font="bold 12px sans-serif",ctx.fillText(`${M.toFixed(2)} N`,15,-15),ctx.restore()}}}for(let z=0;z<charges.length;z++){let R=charges[z],W=z===selectedIdx,H=R.q>0?"#ef4444":"#3b82f6",X=R.q>0?"rgba(239, 68, 68, 0.6)":"rgba(59, 130, 246, 0.6)";W&&(ctx.beginPath(),ctx.arc(R.x,R.y,22,0,2*Math.PI),ctx.strokeStyle="#ffffff",ctx.lineWidth=2,ctx.setLineDash([3,3]),ctx.stroke(),ctx.setLineDash([])),ctx.beginPath();let j=12+Math.min(20,Math.abs(R.q));ctx.arc(R.x,R.y,j,0,2*Math.PI),ctx.fillStyle=H,ctx.shadowColor=X,ctx.shadowBlur=15,ctx.fill(),ctx.shadowBlur=0,ctx.fillStyle="white",ctx.font="bold 10px sans-serif",ctx.textAlign="center",ctx.textBaseline="middle";let G=R.q>0?"+":"";ctx.fillText(`${G}${R.q}`,R.x,R.y)}}function drawArrow(e,t,a,l){ctx.save(),ctx.translate(e,t),ctx.rotate(a),ctx.beginPath(),ctx.moveTo(-l/2,0),ctx.lineTo(l/2,0),ctx.stroke(),ctx.restore()}function updateMonitor(){if(-1===selectedIdx)return;monitorEl.classList.remove("opacity-0","translate-y-4");let e=charges[selectedIdx];document.getElementById("mon-q").innerText=`${e.q>0?"+":""}${e.q} \xb5C`;let t=document.getElementById("mon-list");t.innerHTML="";let a=0,l=0;charges.forEach((c,s)=>{if(s===selectedIdx)return;let n=c.x-e.x,r=c.y-e.y,i=.001*Math.hypot(n,r),o=1e-6*e.q,d=1e-6*c.q,x=9e9*Math.abs(o*d)/(i*i),$=Math.atan2(r,n),h=e.q*c.q>0,g=h?$+Math.PI:$;a+=x*Math.cos(g),l+=x*Math.sin(g);let f=document.createElement("li");f.className="flex justify-between border-b border-slate-800 pb-1",f.innerHTML=`
                    <span>vs Charge ${s+1} (${c.q}\xb5C):</span>
                    <span class="text-emerald-400">${x.toFixed(2)} N</span>
                `,t.appendChild(f)});let c=Math.hypot(a,l);document.getElementById("mon-f").innerText=`${c.toFixed(2)} N`}window.addEventListener("resize",resize),window.addEventListener("load",()=>{resize(),charges.push({id:nextId++,x:canvas.width/2-150,y:canvas.height/2,q:2}),charges.push({id:nextId++,x:canvas.width/2+150,y:canvas.height/2,q:-2}),draw()}),canvas.addEventListener("mousedown",e=>{let{x:t,y:a}=getMousePos(e),l=-1;for(let c=0;c<charges.length;c++){let s=Math.hypot(charges[c].x-t,charges[c].y-a);if(s<20){l=c;break}}-1!==l?(isDragging=!0,selectedIdx=l,updateMonitor(),draw()):(selectedIdx=-1,monitorEl.classList.add("opacity-0","translate-y-4"),draw())}),canvas.addEventListener("mousemove",e=>{if(!isDragging||-1===selectedIdx)return;let{x:t,y:a}=getMousePos(e);charges[selectedIdx].x=t,charges[selectedIdx].y=a,updateMonitor(),draw()}),canvas.addEventListener("mouseup",()=>{isDragging=!1});