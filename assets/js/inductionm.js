const canvas=document.getElementById("sim-canvas"),ctx=canvas.getContext("2d"),container=document.getElementById("canvas-container"),elFluxVal=document.getElementById("val-flux"),elFluxBar=document.getElementById("bar-flux"),elSpeedVal=document.getElementById("val-speed"),elSpeedBar=document.getElementById("bar-speed"),elEmfVal=document.getElementById("val-emf"),elEmfBar=document.getElementById("bar-emf"),bulbIcon=document.getElementById("bulb-icon"),currentDirText=document.getElementById("current-direction"),flowBar=document.getElementById("flow-bar"),CONFIG={coilRadius:70,magnetW:160,magnetH:50,baseB:200};let magnet={x:0,y:0},velocity=0,lastPos=0,isDragging=!1,loops=3,polarity=1,strengthPct=100,flux=0,prevFlux=0,emf=0,lastTime=0;function resize(){canvas.width=container.offsetWidth,canvas.height=container.offsetHeight,isDragging||(magnet.x=canvas.width/2-250,magnet.y=canvas.height/2,lastPos=magnet.x)}function loop(e){let t=(e-lastTime)/1e3||.016;lastTime=e;let l=(magnet.x-lastPos)/t;velocity=.8*velocity+.2*l,lastPos=magnet.x;let a=canvas.width/2,n=magnet.x-a,i=CONFIG.baseB*(strengthPct/100),o=polarity*i*Math.exp(-(n*n)/64800);flux=o;let r=flux-prevFlux;emf=.9*emf+.1*(-loops*r*2.5),prevFlux=flux,updateDashboard(t),draw(),requestAnimationFrame(loop)}function updateDashboard(e){Math.abs(flux).toFixed(1),elFluxVal.innerText=`${flux.toFixed(1)} mWb`,elFluxBar.style.width=`${Math.min(100,Math.abs(flux)/250*100)}%`;let t=Math.abs(velocity/100).toFixed(2);elSpeedVal.innerText=`${t} m/s`,elSpeedBar.style.width=`${Math.min(100,Math.abs(velocity)/20)}%`,elEmfVal.innerText=`${emf.toFixed(2)} V`;let l=emf/150*50;elEmfBar.style.left=emf>0?"50%":`${50+l}%`,elEmfBar.style.width=`${Math.abs(l)}%`,elEmfBar.className=`absolute top-0 h-full transition-all duration-75 ${emf>0?"bg-emerald-400":"bg-rose-400"}`;let a=Math.min(1,Math.abs(emf)/50),n=emf/100*50;flowBar.style.left=emf>0?"50%":`${50+n}%`,flowBar.style.width=`${Math.abs(n)}%`,flowBar.className=`absolute top-0 h-full transition-all duration-75 ${emf>0?"bg-emerald-500":"bg-rose-500"}`,Math.abs(emf)>1?(currentDirText.innerText=emf>0?"CURRENT >>>":"<<< CURRENT",currentDirText.className=`text-xs font-bold ${emf>0?"text-emerald-400":"text-rose-400"}`,bulbIcon.style.backgroundColor="#fef08a",bulbIcon.style.borderColor="#facc15",bulbIcon.style.boxShadow=`0 0 ${40*a}px ${20*a}px rgba(253, 224, 71, 0.5)`):(currentDirText.innerText="NO CURRENT",currentDirText.className="text-xs font-bold text-slate-500",bulbIcon.style.backgroundColor="#334155",bulbIcon.style.borderColor="#475569",bulbIcon.style.boxShadow="none")}function flipPolarity(){polarity*=-1}function draw(){ctx.clearRect(0,0,canvas.width,canvas.height);let e=canvas.width/2,t=canvas.height/2;document.getElementById("show-field").checked&&drawFieldLines(),drawCoil(e,t,!1),drawMagnet(),drawCoil(e,t,!0)}function drawMagnet(){ctx.save(),ctx.translate(magnet.x,magnet.y);let e=CONFIG.magnetW,t=CONFIG.magnetH;ctx.fillStyle="rgba(0,0,0,0.5)",ctx.fillRect(-e/2+10,-t/2+10,e,t);let l=1===polarity?"#3b82f6":"#ef4444",a=1===polarity?"#ef4444":"#3b82f6",n=1===polarity?"S":"N",i=1===polarity?"N":"S";ctx.fillStyle=l,ctx.fillRect(-e/2,-t/2,e/2,t),ctx.fillStyle="white",ctx.font="bold 24px sans-serif",ctx.textAlign="center",ctx.textBaseline="middle",ctx.fillText(n,-e/4,0),ctx.fillStyle=a,ctx.fillRect(0,-t/2,e/2,t),ctx.fillStyle="white",ctx.fillText(i,e/4,0),ctx.strokeStyle="white",ctx.lineWidth=2,ctx.strokeRect(-e/2,-t/2,e,t),ctx.restore()}function drawCoil(e,t,l){let a=CONFIG.coilRadius,n=(loops-1)*25,i=e-n/2;ctx.lineWidth=8,ctx.lineCap="round";for(let o=0;o<loops;o++){let r=i+25*o,s=ctx.createLinearGradient(r-a,t-a,r+a,t+a);s.addColorStop(0,"#78350f"),s.addColorStop(.4,"#fbbf24"),s.addColorStop(1,"#b45309"),ctx.strokeStyle=s,ctx.beginPath(),l?ctx.ellipse(r,t,20,a,0,0,Math.PI):(ctx.strokeStyle="#7c2d12",ctx.ellipse(r,t,20,a,0,Math.PI,2*Math.PI)),ctx.stroke()}}function drawFieldLines(){ctx.save(),ctx.translate(magnet.x,magnet.y),ctx.globalAlpha=.15,ctx.strokeStyle="white",ctx.lineWidth=2;let e=CONFIG.magnetW,t=polarity;for(let l=1;l<=3;l++){let a=80*l;ctx.beginPath(),ctx.moveTo(t*e/2,-10),ctx.bezierCurveTo(t*(e/2+a),-a,-t*(e/2+a),-a,-t*e/2,-10),ctx.stroke(),ctx.beginPath(),ctx.moveTo(t*e/2,10),ctx.bezierCurveTo(t*(e/2+a),a,-t*(e/2+a),a,-t*e/2,10),ctx.stroke()}ctx.restore()}window.addEventListener("resize",resize),window.addEventListener("load",()=>{resize(),loop()}),document.getElementById("slider-loops").addEventListener("input",e=>{loops=parseInt(e.target.value),document.getElementById("display-loops").innerText=loops}),document.getElementById("slider-strength").addEventListener("input",e=>{strengthPct=parseInt(e.target.value),document.getElementById("display-strength").innerText=`${strengthPct}%`}),canvas.addEventListener("mousedown",e=>{let t=canvas.getBoundingClientRect(),l=e.clientX-t.left,a=e.clientY-t.top;l>magnet.x-CONFIG.magnetW/2&&l<magnet.x+CONFIG.magnetW/2&&a>magnet.y-CONFIG.magnetH/2&&a<magnet.y+CONFIG.magnetH/2&&(isDragging=!0,canvas.style.cursor="grabbing")}),window.addEventListener("mousemove",e=>{if(isDragging){let t=canvas.getBoundingClientRect(),l=e.clientX-t.left;l=Math.max(100,Math.min(canvas.width-100,l)),magnet.x=l}}),window.addEventListener("mouseup",()=>{isDragging=!1,canvas.style.cursor="grab"});