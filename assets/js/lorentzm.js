const canvas=document.getElementById("simCanvas"),ctx=canvas.getContext("2d"),DT=.1,TRAIL_LENGTH=500;let particles=[],animationId;const sliderE=document.getElementById("slider-e"),sliderB=document.getElementById("slider-b"),sliderV=document.getElementById("slider-v"),labelE=document.getElementById("val-e"),labelB=document.getElementById("val-b");function resize(){canvas.width=canvas.parentElement.offsetWidth,canvas.height=canvas.parentElement.offsetHeight}window.addEventListener("resize",resize),window.addEventListener("load",()=>{resize(),loop()});class Particle{constructor(t,e,i,l){this.x=t,this.y=e,this.vx=i,this.vy=l,this.trail=[],this.color=`hsl(${60*Math.random()+200}, 100%, 70%)`,this.life=1}update(t,e){let i=this.vy*e*.2,l=-this.vx*e*.2;this.vx+=.1*i,this.vy+=(.5*t+l)*.1,this.x+=.1*this.vx,this.y+=.1*this.vy,this.trail.push({x:this.x,y:this.y}),this.trail.length>500&&this.trail.shift(),(this.x>canvas.width+100||this.x<-100||this.y>canvas.height+100||this.y<-100)&&(this.life=0)}draw(){if(this.trail.length>1){ctx.beginPath(),ctx.moveTo(this.trail[0].x,this.trail[0].y);for(let t=1;t<this.trail.length;t++)ctx.lineTo(this.trail[t].x,this.trail[t].y);ctx.strokeStyle=this.color,ctx.lineWidth=2,ctx.stroke()}ctx.beginPath(),ctx.arc(this.x,this.y,4,0,2*Math.PI),ctx.fillStyle="#fff",ctx.fill(),ctx.shadowColor=this.color,ctx.shadowBlur=10}}function fireParticle(){let t=5*parseFloat(sliderV.value);particles.push(new Particle(50,canvas.height/2,t,0))}function clearCanvas(){particles=[]}function setPreset(t){clearCanvas(),"cyclotron"===t?(sliderE.value=0,sliderB.value=5,sliderV.value=4):"selector"===t&&(sliderE.value=5,sliderB.value=-3,sliderV.value=5)}function loop(){let t=parseFloat(sliderE.value),e=parseFloat(sliderB.value);labelE.innerText=t.toFixed(1),labelB.innerText=e.toFixed(1),ctx.fillStyle="rgba(15, 23, 42, 0.3)",ctx.fillRect(0,0,canvas.width,canvas.height),drawFieldBackground(t,e);for(let i=particles.length-1;i>=0;i--){let l=particles[i];l.update(t,e),l.draw(),l.life<=0&&particles.splice(i,1)}ctx.fillStyle="#475569",ctx.fillRect(0,canvas.height/2-10,50,20),ctx.fillStyle="#10b981",ctx.fillRect(45,canvas.height/2-5,5,10),requestAnimationFrame(loop)}function drawFieldBackground(t,e){ctx.save();let i=60;if(Math.abs(e)>.5){ctx.fillStyle="rgba(59, 130, 246, 0.2)",ctx.strokeStyle="rgba(59, 130, 246, 0.4)",ctx.font="14px sans-serif",ctx.textAlign="center",ctx.textBaseline="middle";for(let l=i/2;l<canvas.width;l+=i)for(let s=i/2;s<canvas.height;s+=i)e>0?(ctx.beginPath(),ctx.arc(l,s,2,0,2*Math.PI),ctx.fill(),ctx.beginPath(),ctx.arc(l,s,6,0,2*Math.PI),ctx.stroke()):(ctx.beginPath(),ctx.moveTo(l-4,s-4),ctx.lineTo(l+4,s+4),ctx.moveTo(l+4,s-4),ctx.lineTo(l-4,s+4),ctx.stroke())}if(Math.abs(t)>.5){ctx.strokeStyle="rgba(239, 68, 68, 0.3)",ctx.lineWidth=1;for(let a=i;a<canvas.width;a+=i)for(let c=i;c<canvas.height;c+=i)ctx.beginPath(),ctx.moveTo(a,c-10),ctx.lineTo(a,c+10),t>0?(ctx.lineTo(a-3,c+10-5),ctx.moveTo(a,c+10),ctx.lineTo(a+3,c+10-5)):(ctx.moveTo(a,c-10),ctx.lineTo(a-3,c-10+5),ctx.moveTo(a,c-10),ctx.lineTo(a+3,c-10+5)),ctx.stroke()}ctx.restore()}