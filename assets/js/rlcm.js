const scopeCanvas=document.getElementById("scopeCanvas"),phasorCanvas=document.getElementById("phasorCanvas"),scopeCtx=scopeCanvas.getContext("2d"),phasorCtx=phasorCanvas.getContext("2d"),circuitSelector=document.getElementById("circuit-selector"),circuitSvgPlaceholder=document.getElementById("circuit-svg-placeholder"),parallelNote=document.getElementById("parallel-note"),btnResonance=document.getElementById("btn-resonance"),sliderF=document.getElementById("slider-f"),sliderL=document.getElementById("slider-l"),sliderC=document.getElementById("slider-c"),sliderR=document.getElementById("slider-r"),containerL=document.getElementById("container-l"),containerC=document.getElementById("container-c"),dispF=document.getElementById("disp-f"),dispL=document.getElementById("disp-l"),dispC=document.getElementById("disp-c"),dispR=document.getElementById("disp-r"),valXL=document.getElementById("val-xl"),valXC=document.getElementById("val-xc"),valZ=document.getElementById("val-z"),valPhase=document.getElementById("val-phase"),valI=document.getElementById("val-i"),barI=document.getElementById("bar-i"),resBulb=document.getElementById("res-bulb"),resText=document.getElementById("res-text");let activeCircuit="series-rlc",params={f:50,L:.1,C:5e-5,R:50},t=0,traceV=[],traceI=[];const MAX_TRACE=300,SVGs={"series-rlc":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 100" class="w-full h-auto" stroke="currentColor" fill="none" stroke-width="2"><text x="10" y="20" fill="#94a3b8" font-size="10">SERIES RLC</text><path d="M20,50 H40" stroke="#34d399"/><circle cx="30" cy="50" r="8" stroke="#34d399"/><text x="24" y="53" fill="#34d399" font-size="10" font-weight="bold">~</text><path d="M40,50 l5,-5 l10,10 l10,-10 l10,10 l10,-10 l5,5 H100" stroke="#cbd5e1"/><text x="65" y="35" fill="#cbd5e1" font-size="10">R</text><path d="M100,50 q5,-10 10,0 t10,0 t10,0 t10,0 H150" stroke="#3b82f6"/><text x="120" y="35" fill="#3b82f6" font-size="10">L</text><path d="M150,50 H160 M160,40 V60 M170,40 V60 M170,50 H180" stroke="#ef4444"/><text x="162" y="35" fill="#ef4444" font-size="10">C</text><path d="M180,50 H190 V80 H10 V50 H20" stroke="#64748b"/></svg>',"parallel-rlc":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 100" class="w-full h-auto" stroke="currentColor" fill="none" stroke-width="2"><text x="10" y="20" fill="#94a3b8" font-size="10">PARALLEL RLC</text><path d="M20,50 H40" stroke="#34d399"/><circle cx="30" cy="50" r="8" stroke="#34d399"/><text x="24" y="53" fill="#34d399" font-size="10" font-weight="bold">~</text><path d="M40,50 H60 V30 H160 V50 H180" stroke="#64748b"/><path d="M60,50 V70 H160 V50" stroke="#64748b"/><path d="M180,50 H190 V90 H10 V50 H20" stroke="#64748b"/><path d="M80,30 V35 l-5,5 l10,10 l-10,10 l10,10 l-5,5 V70" stroke="#cbd5e1"/><text x="75" y="25" fill="#cbd5e1" font-size="10">R</text><path d="M110,30 V35 q-10,5 0,10 t0,10 t0,10 t0,5 V70" stroke="#3b82f6"/><text x="105" y="25" fill="#3b82f6" font-size="10">L</text><path d="M140,30 V45 M130,45 H150 M130,55 H150 M140,55 V70" stroke="#ef4444"/><text x="135" y="25" fill="#ef4444" font-size="10">C</text></svg>',"series-rc":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 100" class="w-full h-auto" stroke="currentColor" fill="none" stroke-width="2"><text x="10" y="20" fill="#94a3b8" font-size="10">SERIES RC</text><path d="M20,50 H40" stroke="#34d399"/><circle cx="30" cy="50" r="8" stroke="#34d399"/><text x="24" y="53" fill="#34d399" font-size="10" font-weight="bold">~</text><path d="M40,50 l5,-5 l10,10 l10,-10 l10,10 l10,-10 l5,5 H100" stroke="#cbd5e1"/><text x="65" y="35" fill="#cbd5e1" font-size="10">R</text><path d="M100,50 H120 M120,40 V60 M130,40 V60 M130,50 H150" stroke="#ef4444"/><text x="122" y="35" fill="#ef4444" font-size="10">C</text><path d="M150,50 H170 V80 H10 V50 H20" stroke="#64748b"/></svg>',"series-rl":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 100" class="w-full h-auto" stroke="currentColor" fill="none" stroke-width="2"><text x="10" y="20" fill="#94a3b8" font-size="10">SERIES RL</text><path d="M20,50 H40" stroke="#34d399"/><circle cx="30" cy="50" r="8" stroke="#34d399"/><text x="24" y="53" fill="#34d399" font-size="10" font-weight="bold">~</text><path d="M40,50 l5,-5 l10,10 l10,-10 l10,10 l10,-10 l5,5 H100" stroke="#cbd5e1"/><text x="65" y="35" fill="#cbd5e1" font-size="10">R</text><path d="M100,50 q5,-10 10,0 t10,0 t10,0 t10,0 H150" stroke="#3b82f6"/><text x="120" y="35" fill="#3b82f6" font-size="10">L</text><path d="M150,50 H170 V80 H10 V50 H20" stroke="#64748b"/></svg>'};function resize(){scopeCanvas.width=scopeCanvas.parentElement.offsetWidth,scopeCanvas.height=scopeCanvas.parentElement.offsetHeight,phasorCanvas.width=phasorCanvas.parentElement.offsetWidth,phasorCanvas.height=phasorCanvas.parentElement.offsetHeight}function updateCircuitUI(){circuitSvgPlaceholder.innerHTML=SVGs[activeCircuit],sliderL.disabled="series-rc"===activeCircuit,sliderC.disabled="series-rl"===activeCircuit,containerL.style.opacity=sliderL.disabled?.4:1,containerC.style.opacity=sliderC.disabled?.4:1;let e=activeCircuit.includes("rlc");btnResonance.style.display=e?"block":"none",parallelNote.style.display="parallel-rlc"===activeCircuit?"block":"none"}function loop(){updateParams();let e=calculateCircuitEngine();updateUI(e),drawScope(e),drawPhasor(e),t+=.06,requestAnimationFrame(loop)}function updateParams(){params.f=parseFloat(sliderF.value),params.L=parseFloat(sliderL.value)/1e3,params.C=parseFloat(sliderC.value)/1e6,params.R=parseFloat(sliderR.value),dispF.innerText=`${params.f} Hz`,dispL.innerText=`${(1e3*params.L).toFixed(0)} mH`,dispC.innerText=`${(1e6*params.C).toFixed(0)} \xb5F`,dispR.innerText=`${params.R} Ω`}function calculateCircuitEngine(){let e=2*Math.PI*params.f,$="series-rc"===activeCircuit?0:e*params.L,a="series-rl"===activeCircuit?0:1/(e*params.C),l,r,s;switch(activeCircuit){case"series-rlc":l=Math.sqrt(Math.pow(params.R,2)+Math.pow($-a,2)),r=Math.atan2($-a,params.R);break;case"series-rc":l=Math.sqrt(Math.pow(params.R,2)+Math.pow(a,2)),r=Math.atan2(-a,params.R);break;case"series-rl":l=Math.sqrt(Math.pow(params.R,2)+Math.pow($,2)),r=Math.atan2($,params.R);break;case"parallel-rlc":let i=100/params.R,n=100/$,o=100/a;l=100/(s=Math.sqrt(Math.pow(i,2)+Math.pow(o-n,2))),r=Math.atan2(-(o-n),i)}"parallel-rlc"!==activeCircuit&&(s=100/l);let c=s*("parallel-rlc"===activeCircuit?20:100);return{XL:$,XC:a,Z:l,phase:r,I_peak_visual:c,I_rms:s}}function drawScope(e){let $=scopeCanvas.width,a=scopeCanvas.height,l=a/2,r=Math.sin(t)*(.3*a),s=Math.sin(t-e.phase)*(.8*e.I_peak_visual);traceV.push(r),traceI.push(s),traceV.length>$&&(traceV.shift(),traceI.shift()),scopeCtx.clearRect(0,0,$,a),drawTrace(scopeCtx,traceV,"#34d399",l),drawTrace(scopeCtx,traceI,"#facc15",l)}function drawTrace(e,$,a,l){e.beginPath(),e.strokeStyle=a,e.lineWidth=2;for(let r=0;r<$.length;r++)e.lineTo(r,l-$[r]);e.stroke()}function drawPhasor(e){let $=phasorCtx,a=phasorCanvas.width,l=phasorCanvas.height,r=a/2,s=l/2;$.clearRect(0,0,a,l),$.strokeStyle="#475569",$.beginPath(),$.moveTo(0,s),$.lineTo(a,s),$.stroke(),$.beginPath(),$.moveTo(r,0),$.lineTo(r,l),$.stroke();let i=-t;drawVector($,r,s,35,i,"#34d399");let n=Math.min(52.5,e.I_rms*("parallel-rlc"===activeCircuit?5:25));drawVector($,r,s,n,i-e.phase,"#facc15")}function drawVector(e,$,a,l,r,s){e.save(),e.translate($,a),e.rotate(r),e.beginPath(),e.moveTo(0,0),e.lineTo(l,0),e.strokeStyle=s,e.lineWidth=2,e.stroke(),e.beginPath(),e.moveTo(l,0),e.lineTo(l-4,-3),e.lineTo(l-4,3),e.fillStyle=s,e.fill(),e.restore()}function updateUI(e){valXL.innerText=activeCircuit.includes("rc")?"-":`${e.XL.toFixed(0)}Ω`,valXC.innerText=activeCircuit.includes("rl")&&!activeCircuit.includes("rlc")?"-":`${e.XC.toFixed(0)}Ω`,valZ.innerText=isFinite(e.Z)?`${e.Z.toFixed(0)}Ω`:"∞";let $=(180*e.phase/Math.PI).toFixed(1);valPhase.innerText=`${$}\xb0`,valI.innerText=`${e.I_rms.toFixed(2)} A`;let a="parallel-rlc"===activeCircuit?10:3,l=e.I_rms/a*100;barI.style.width=`${Math.min(100,l)}%`;let r=!1;if(activeCircuit.includes("rlc")){let s=e.XL/e.XC;r=s>.95&&s<1.05}r?(resBulb.className="w-4 h-4 rounded-full bg-emerald-500 shadow-[0_0_15px_rgba(16,185,129,0.8)] transition-all duration-300",resText.innerText="parallel-rlc"===activeCircuit?"RESONANCE (MIN I)":"RESONANCE (MAX I)",resText.className="text-xs font-bold text-emerald-400 animate-pulse"):(resBulb.className="w-4 h-4 rounded-full bg-slate-600 transition-all duration-300",resText.innerText="OFF",resText.className="text-xs font-bold text-slate-500")}function setResonance(){if(!activeCircuit.includes("rlc"))return;let e=1/(2*Math.PI*Math.sqrt(params.L*params.C));sliderF.value=Math.min(200,Math.max(10,e))}window.addEventListener("resize",resize),window.addEventListener("load",()=>{resize(),updateCircuitUI(),loop()}),circuitSelector.addEventListener("change",e=>{activeCircuit=e.target.value,updateCircuitUI(),traceV=[],traceI=[]});