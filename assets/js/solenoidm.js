const canvas=document.getElementById("sim-canvas"),ctx=canvas.getContext("2d"),deviceSelector=document.getElementById("device-selector"),coreSelector=document.getElementById("core-selector"),sliderI=document.getElementById("slider-i"),sliderN=document.getElementById("slider-n"),sliderGeom=document.getElementById("slider-geom"),dispI=document.getElementById("disp-i"),dispN=document.getElementById("disp-n"),dispGeom=document.getElementById("disp-geom"),labelGeom=document.getElementById("label-geom"),valB=document.getElementById("val-b"),barB=document.getElementById("bar-b"),densityVal=document.getElementById("density-val"),densityBar=document.getElementById("density-bar"),coreWarning=document.getElementById("core-warning"),modeDisplay=document.getElementById("mode-display"),theorySolenoid=document.getElementById("theory-solenoid"),theoryToroid=document.getElementById("theory-toroid"),formulaN=document.getElementById("formula-n"),MU_0=4*Math.PI*1e-7;let mode="solenoid",params={I:2,N:50,dim:.2,mu_r:1},B_field=0,time=0;function resize(){canvas.width=canvas.parentElement.offsetWidth,canvas.height=canvas.parentElement.offsetHeight}function updateUI(){params.I=parseFloat(sliderI.value),params.N=parseInt(sliderN.value),params.dim=parseFloat(sliderGeom.value),params.mu_r=parseInt(coreSelector.value),dispI.innerText=`${params.I.toFixed(1)} A`,dispN.innerText=params.N,dispGeom.innerText=`${params.dim.toFixed(2)} m`,coreWarning.style.display=params.mu_r>10?"block":"none",modeDisplay.innerText=`${mode.charAt(0).toUpperCase()+mode.slice(1)} (${coreSelector.options[coreSelector.selectedIndex].text.split("(")[0].trim()})`,B_field="solenoid"===mode?MU_0*params.mu_r*params.N*params.I/params.dim:MU_0*params.mu_r*params.N*params.I/(2*Math.PI*params.dim);let e=1e3*B_field;valB.innerText=e.toFixed(2);let t=Math.log10(e+1)/Math.log10(2e3)*100;barB.style.width=`${Math.min(100,Math.max(1,t))}%`,densityBar.style.width=`${Math.min(100,t)}%`,t<30?densityVal.innerText="Weak":t<70?densityVal.innerText="Moderate":densityVal.innerText="Strong (Saturated)"}function loop(){ctx.clearRect(0,0,canvas.width,canvas.height),"solenoid"===mode?drawSolenoid():drawToroid(),time+=.05*(params.I/5),requestAnimationFrame(loop)}function drawSolenoid(){let e=canvas.width/2,t=canvas.height/2,i=100+params.dim/.5*200;ctx.fillStyle=params.mu_r>10?"#94a3b8":"#1e293b",ctx.fillRect(e-i/2,t-60+5,i,110),params.mu_r>10&&(ctx.fillStyle="#1e293b",ctx.font="10px sans-serif",ctx.textAlign="center",ctx.fillText("IRON CORE",e,t));let l=Math.min(1,100*B_field);ctx.strokeStyle=`rgba(251, 191, 36, ${l})`,ctx.lineWidth=2;for(let a=0;a<5;a++){let n=(a-2)*30;ctx.beginPath(),ctx.moveTo(e-i/2-50,t+n),ctx.lineTo(e+i/2+50,t+n),ctx.stroke();let r=(5*time+20*a)%(i+100);ctx.fillStyle="#fbbf24",ctx.beginPath(),ctx.arc(e-i/2-50+r,t+n,2,0,2*Math.PI),ctx.fill()}let o=Math.min(30,Math.max(5,Math.floor(params.N/5))),d=i/o,s=e-i/2;ctx.lineWidth=4;for(let c=0;c<o;c++){let m=s+c*d+d/2;ctx.beginPath(),ctx.strokeStyle="#78350f",ctx.arc(m,t,60,Math.PI,0),ctx.ellipse(m,t,10,60,0,Math.PI/2,3*Math.PI/2),ctx.stroke()}for(let $=0;$<o;$++){let x=s+$*d+d/2;ctx.beginPath(),ctx.strokeStyle="#f59e0b",ctx.ellipse(x,t,10,60,0,-Math.PI/2,Math.PI/2),ctx.stroke()}}function drawToroid(){let e=canvas.width/2,t=canvas.height/2,i=80+params.dim/.5*50;ctx.beginPath(),ctx.arc(e,t,i,0,2*Math.PI),ctx.lineWidth=60,ctx.strokeStyle=params.mu_r>10?"#64748b":"#1e293b",ctx.stroke();let l=Math.min(1,100*B_field);ctx.strokeStyle=`rgba(251, 191, 36, ${l})`,ctx.lineWidth=2,ctx.beginPath(),ctx.arc(e,t,i,0,2*Math.PI),ctx.stroke();for(let a=0;a<8;a++){let n=(.05*time+a*(2*Math.PI)/8)%(2*Math.PI),r=e+Math.cos(n)*i,o=t+Math.sin(n)*i;ctx.fillStyle="#fbbf24",ctx.beginPath(),ctx.arc(r,o,3,0,2*Math.PI),ctx.fill()}let d=Math.min(40,params.N),s=2*Math.PI/d;for(let c=0;c<d;c++){let m=c*s,$=e+Math.cos(m)*i,x=t+Math.sin(m)*i;ctx.save(),ctx.translate($,x),ctx.rotate(m),ctx.beginPath(),ctx.strokeStyle="#f59e0b",ctx.lineWidth=3,ctx.ellipse(0,0,32,8,0,0,2*Math.PI),ctx.stroke(),ctx.restore()}}window.addEventListener("resize",resize),window.addEventListener("load",()=>{resize(),updateUI(),loop()}),deviceSelector.addEventListener("change",e=>{"solenoid"===(mode=e.target.value)?(labelGeom.innerText="Length (L)",modeDisplay.innerText="Solenoid",theorySolenoid.style.display="block",theoryToroid.style.display="none",formulaN.innerText="n = N / L"):(labelGeom.innerText="Mean Radius (R)",modeDisplay.innerText="Toroid",theorySolenoid.style.display="none",theoryToroid.style.display="block",formulaN.innerText="n = N / (2Ï€R)"),updateUI()}),coreSelector.addEventListener("change",updateUI),sliderI.addEventListener("input",updateUI),sliderN.addEventListener("input",updateUI),sliderGeom.addEventListener("input",updateUI);