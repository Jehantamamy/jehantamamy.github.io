const CANVAS_W=1e3,CANVAS_H=400;let robotX=500,robotAngle=0,lineX=500,trackOffset=0,lastTime=performance.now(),lastError=0,integral=0,currentAngularVel=0,actualLeftSpeed=0,actualRightSpeed=0;const canvas=document.getElementById("simCanvas"),ctx=canvas.getContext("2d");canvas.width=1e3,canvas.height=400;const ctxChart=document.getElementById("chartCanvas").getContext("2d"),perfChart=new Chart(ctxChart,{type:"line",data:{labels:Array(150).fill(""),datasets:[{label:"Robot",data:Array(150).fill(50),borderColor:"#f43f5e",borderWidth:2,pointRadius:0,tension:.1},{label:"Target",data:Array(150).fill(50),borderColor:"#fbbf24",borderWidth:2,borderDash:[5,5],pointRadius:0,fill:!0,backgroundColor:"rgba(251, 191, 36, 0.05)"}]},options:{responsive:!0,maintainAspectRatio:!1,animation:!1,interaction:{mode:"none"},scales:{y:{min:0,max:100,grid:{color:"#1e293b"}},x:{display:!1}},plugins:{legend:{display:!0},tooltip:{enabled:!1}}}});function loop(){let t=performance.now(),e=(t-lastTime)/1e3;lastTime=t,e>.1&&(e=.1);let l=parseInt(document.getElementById("base-speed").value),a=parseFloat(document.getElementById("kp").value),n=parseFloat(document.getElementById("ki").value),$=parseFloat(document.getElementById("kd").value),r=parseInt(document.getElementById("inertia").value),o=parseInt(document.getElementById("friction").value),i=parseFloat(document.getElementById("line-pos").value),c=parseInt(document.getElementById("sensor-limit").value),d=document.getElementById("control-mode").value,s=document.getElementById("sensor-type").value;document.getElementById("val-base").innerText=l,document.getElementById("val-kp").innerText=a.toFixed(1),document.getElementById("val-ki").innerText=n.toFixed(3),document.getElementById("val-kd").innerText=$.toFixed(1),document.getElementById("val-inertia").innerText=r+"%",document.getElementById("val-friction").innerText=o+"%",document.getElementById("val-sensor").innerText=c+"px";let g=i/100*1e3,x=robotX+45*Math.sin(robotAngle),_=g-x;if("analog"!==s){let f=c/("digital-8"===s?8:16);_=Math.round(_/f)*f}let u=_,b=c/2,m=!1;u>b?(u=b,m=!0):u<-b&&(u=-b,m=!0),integral+=u*e;let h=(u-lastError)/e;integral>100&&(integral=100),integral<-100&&(integral=-100);let p=(a*u+n*integral+$*h)*.5;lastError=u;let y=l+p,v=l-p;y=Math.max(-255,Math.min(255,y)),v=Math.max(-255,Math.min(255,v));let B,E;"direct"===d?(actualLeftSpeed=y,actualRightSpeed=v):(actualLeftSpeed+=(y-actualLeftSpeed)*.2,actualRightSpeed+=(v-actualRightSpeed)*.2),B=actualLeftSpeed,E=actualRightSpeed;let I=(B-E)*.04;if(0===r)currentAngularVel=I;else{let S=.8-r/120;S<.01&&(S=.01),currentAngularVel+=(I-currentAngularVel)*S}currentAngularVel*=.995-o/500,(robotAngle+=currentAngularVel*e)>1.5&&(robotAngle=1.5),robotAngle<-1.5&&(robotAngle=-1.5);let A=(B+E)*.5;(trackOffset+=A*e*2)>80&&(trackOffset=0),(robotX+=Math.sin(robotAngle)*(Math.abs(A)+50)*e*3)<20&&(robotX=20,robotAngle=.1,currentAngularVel=0),robotX>980&&(robotX=980,robotAngle=-.1,currentAngularVel=0),drawScene(g,robotX,robotAngle,c),updateBars(B,E),document.getElementById("disp-error").innerText=u.toFixed(1),document.getElementById("disp-angle").innerText=(57.29*robotAngle).toFixed(1);let T=document.getElementById("sat-indicator");m?T.classList.remove("hidden"):T.classList.add("hidden"),updateChartData(g,x),requestAnimationFrame(loop)}function drawScene(t,e,l,a){ctx.fillStyle="#0f172a",ctx.fillRect(0,0,1e3,400),ctx.strokeStyle="#1e293b",ctx.lineWidth=1;for(let n=0;n<=1e3;n+=100)ctx.beginPath(),ctx.moveTo(n,0),ctx.lineTo(n,400),ctx.stroke();for(let $=trackOffset;$<400;$+=80)ctx.beginPath(),ctx.moveTo(0,$),ctx.lineTo(1e3,$),ctx.stroke();ctx.shadowColor="#fbbf24",ctx.shadowBlur=10,ctx.strokeStyle="#fbbf24",ctx.lineWidth=4,ctx.beginPath(),ctx.moveTo(t,0),ctx.lineTo(t,400),ctx.stroke(),ctx.shadowBlur=0,ctx.save(),ctx.translate(e,320),ctx.rotate(l),ctx.fillStyle="rgba(16, 185, 129, 0.15)",ctx.fillRect(-a/2,-45,a,15),ctx.strokeStyle="#34d399",ctx.lineWidth=1,ctx.setLineDash([2,2]),ctx.strokeRect(-a/2,-45,a,15),ctx.setLineDash([]),ctx.fillStyle="#334155",ctx.strokeStyle="#94a3b8",ctx.lineWidth=2,ctx.beginPath(),ctx.roundRect(-30,-40,60,80,10),ctx.fill(),ctx.stroke(),ctx.fillStyle="#38bdf8",ctx.fillRect(-38,-20,8,40),ctx.fillStyle="#f43f5e",ctx.fillRect(30,-20,8,40),ctx.fillStyle="#10b981",ctx.fillRect(-20,-38,40,4),ctx.beginPath(),ctx.moveTo(0,-30),ctx.lineTo(-8,-10),ctx.lineTo(8,-10),ctx.fillStyle="#fbbf24",ctx.fill(),ctx.restore()}function updateBars(t,e){document.getElementById("bar-left").style.height=`${(t+255)/510*100}%`,document.getElementById("bar-right").style.height=`${(e+255)/510*100}%`}let frameCount=0;function updateChartData(t,e){if(++frameCount%3!=0)return;let l=perfChart.data.datasets[0].data,a=perfChart.data.datasets[1].data;l.push(e/1e3*100),l.shift(),a.push(t/1e3*100),a.shift(),perfChart.update("none")}function setLine(t){document.getElementById("line-pos").value=t}loop();