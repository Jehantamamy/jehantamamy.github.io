const simCanvas=document.getElementById("sim-canvas"),scopeCanvas=document.getElementById("scope-canvas"),simCtx=simCanvas.getContext("2d"),scopeCtx=scopeCanvas.getContext("2d"),sliderNp=document.getElementById("slider-np"),sliderNs=document.getElementById("slider-ns"),sliderVp=document.getElementById("slider-vp"),dispNp=document.getElementById("disp-np"),dispNs=document.getElementById("disp-ns"),dispVp=document.getElementById("disp-vp"),valVpDisp=document.getElementById("val-vp-disp"),valVsDisp=document.getElementById("val-vs-disp"),ratioDisp=document.getElementById("ratio-disp"),typeDisp=document.getElementById("type-disp"),bulbIcon=document.getElementById("bulb-icon"),bulbText=document.getElementById("bulb-text");let params={np:200,ns:100,vp:220,vs:110},time=0,traceP=[],traceS=[];const MAX_TRACE=400;function resize(){simCanvas.width=simCanvas.parentElement.offsetWidth,simCanvas.height=simCanvas.parentElement.offsetHeight,scopeCanvas.width=scopeCanvas.parentElement.offsetWidth,scopeCanvas.height=scopeCanvas.parentElement.offsetHeight}function loop(){updatePhysics(),drawTransformer(),drawScope(),time+=.1,requestAnimationFrame(loop)}function updatePhysics(){params.np=parseInt(sliderNp.value),params.ns=parseInt(sliderNs.value),params.vp=parseInt(sliderVp.value),params.vs=params.vp*(params.ns/params.np),dispNp.innerText=params.np,dispNs.innerText=params.ns,dispVp.innerText=`${params.vp} V`,valVpDisp.innerText=`${params.vp}V`,valVsDisp.innerText=`${params.vs.toFixed(0)}V`;let e=(params.np/params.ns).toFixed(1);ratioDisp.innerText=`${e} : 1`,params.ns>params.np?(typeDisp.innerText="STEP-UP",typeDisp.className="text-xs font-bold bg-emerald-900 text-emerald-300 px-2 py-1 rounded"):params.ns<params.np?(typeDisp.innerText="STEP-DOWN",typeDisp.className="text-xs font-bold bg-rose-900 text-rose-300 px-2 py-1 rounded"):(typeDisp.innerText="ISOLATION",typeDisp.className="text-xs font-bold bg-slate-800 text-slate-300 px-2 py-1 rounded");let t=Math.min(1.5,params.vs/220),s=`rgba(253, 224, 71, ${Math.min(1,t)})`;params.vs>250?(bulbText.innerText="OVERLOAD!",bulbText.className="text-xs font-bold text-red-500 animate-pulse"):params.vs>50?(bulbText.innerText="Normal",bulbText.className="text-xs text-white"):(bulbText.innerText="Dim",bulbText.className="text-xs text-slate-500"),bulbIcon.style.backgroundColor=t>.1?"#fef08a":"#334155",bulbIcon.style.boxShadow=`0 0 ${30*t}px ${10*t}px ${s}`}function drawTransformer(){let e=simCtx,t=simCanvas.width,s=simCanvas.height,a=t/2,n=s/2;e.clearRect(0,0,t,s),e.fillStyle="#475569",e.fillRect(a-90,n-70,180,140),e.fillStyle="#0f172a",e.fillRect(a-90+40,n-70+40,100,60),e.strokeStyle="rgba(251, 191, 36, 0.4)",e.setLineDash([5,5]),e.lineWidth=2,e.lineDashOffset=-(2*time),e.beginPath();e.rect(a-90+20,n-70+20,140,100),e.stroke(),e.setLineDash([]),drawCoil(e,a-90,n,params.np,"#3b82f6",!0),drawCoil(e,a+90-40,n,params.ns,"#ef4444",!1)}function drawCoil(e,t,s,a,n,i){let p=Math.min(20,Math.max(5,Math.floor(a/20))),l=100/p,r=s-50;e.lineWidth=4,e.strokeStyle=n;for(let o=0;o<p;o++){let $=r+o*l;e.beginPath(),e.moveTo(t,$),i?e.bezierCurveTo(t-30,$,t-30,$+10,t,$+10):e.bezierCurveTo(t+70,$,t+70,$+10,t+40,$+10),e.stroke()}e.lineWidth=2,e.beginPath(),i?(e.moveTo(t-15,r),e.lineTo(t-60,r),e.moveTo(t-15,r+100),e.lineTo(t-60,r+100)):(e.moveTo(t+55,r),e.lineTo(t+100,r),e.moveTo(t+55,r+100),e.lineTo(t+100,r+100)),e.stroke()}function drawScope(){let e=scopeCtx,t=scopeCanvas.width,s=scopeCanvas.height,a=s/2,n=Math.sin(time)*params.vp*.3,i=Math.sin(time)*params.vs*.3;traceP.push(n),traceS.push(i),traceP.length>t&&(traceP.shift(),traceS.shift()),e.clearRect(0,0,t,s),e.beginPath(),e.strokeStyle="#3b82f6",e.lineWidth=2;for(let p=0;p<traceP.length;p++)e.lineTo(p,a-traceP[p]);e.stroke(),e.beginPath(),e.strokeStyle="#ef4444",e.lineWidth=2;for(let l=0;l<traceS.length;l++)e.lineTo(l,a-traceS[l]);e.stroke()}window.addEventListener("resize",resize),window.addEventListener("load",()=>{resize(),loop()});