!function(){let e=window.location.hostname;if("localhost"===e||"127.0.0.1"===e||""===e){"file:"===window.location.protocol&&t();return}function t(){throw document.body.innerHTML=`
					<div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; background:#0f172a; color:white; font-family:sans-serif; text-align:center;">
						<h1 style="font-size:3rem; color:#ef4444;">â›” AKSES DITOLAK</h1>
						<p style="font-size:1.2rem; margin-top:1rem;">Aplikasi ini dilindungi Hak Cipta dan hanya dapat digunakan melalui website resmi.</p>
						<a href="https://ariestechlab.com" style="margin-top:2rem; padding:10px 20px; background:#10b981; color:white; text-decoration:none; border-radius:8px; font-weight:bold;">Buka Aries Tech Labs</a>
					</div>
				`,Error("Illegal execution environment detected.")}["ariestechlab.com","www.ariestechlab.com"].includes(e)||t()}();const DAW={audioCtx:null,masterGain:null,destStream:null,reverbIR:null,pixelsPerSecond:50,isPlaying:!1,playheadSec:0,durationSec:60,tracks:[],colors:["#0ea5e9","#f43f5e","#10b981","#f59e0b","#8b5cf6","#ec4899"]};class Track{constructor(e,t,a){this.id=e,this.name=t,this.color=a,this.regions=[],this.volume=1,this.muted=!1,this.pan=0,this.filter=50,this.delay=0,this.reverb=0}}let activeSources=[],playStartTime=0,animationFrame=null,selectedRegionInfo=null,clipboardRegionData=null;function initAudio(){DAW.audioCtx||(DAW.audioCtx=new(window.AudioContext||window.webkitAudioContext),DAW.masterGain=DAW.audioCtx.createGain(),DAW.masterAnalyser=DAW.audioCtx.createAnalyser(),DAW.masterAnalyser.fftSize=256,DAW.masterDataArray=new Uint8Array(DAW.masterAnalyser.frequencyBinCount),DAW.masterGain.connect(DAW.masterAnalyser),DAW.masterAnalyser.connect(DAW.audioCtx.destination),DAW.destStream=DAW.audioCtx.createMediaStreamDestination(),DAW.masterAnalyser.connect(DAW.destStream),"function"==typeof createReverbIR&&createReverbIR(),"function"==typeof drawVUMeter&&drawVUMeter())}function createReverbIR(){let e=DAW.audioCtx.sampleRate,t=2.5*e,a=DAW.audioCtx.createBuffer(2,t,e);for(let n=0;n<t;n++){let i=Math.exp(-n/(.3*e));a.getChannelData(0)[n]=(2*Math.random()-1)*i,a.getChannelData(1)[n]=(2*Math.random()-1)*i}DAW.reverbIR=a}function handleFileUpload(e,t){let a=t.files[0];if(!a)return;initAudio(),"suspended"===DAW.audioCtx.state&&DAW.audioCtx.resume();let n=new FileReader;n.onload=async function(t){try{let a=t.target.result,n=await DAW.audioCtx.decodeAudioData(a),i=DAW.tracks.find(t=>t.id===e);if(i){let r=DAW.playheadSec||0;i.regions.push({id:Date.now(),buffer:n,startOffset:0,startTime:r,duration:n.duration,fadeIn:0,fadeOut:0}),r+n.duration>DAW.durationSec&&(DAW.durationSec=Math.ceil(r+n.duration)+10),renderTrackLanes(),renderRegions(),"function"==typeof saveState&&saveState(),setTimeout(()=>{let e=document.getElementById("arranger-scroll"),t=r*DAW.pixelsPerSecond;e&&(e.scrollLeft=Math.max(0,t-50))},50)}}catch(o){console.error("Audio Decode Error:",o),alert("Gagal memproses audio! Format file mungkin rusak atau tidak didukung.")}},n.onerror=function(){alert("Browser gagal membaca file dari komputermu!")},n.readAsArrayBuffer(a)}let trackCounter=0;function addTrack(){trackCounter++;let e=Date.now()+trackCounter,t=DAW.colors[DAW.tracks.length%DAW.colors.length];DAW.tracks.push(new Track(e,`Track ${DAW.tracks.length+1}`,t)),renderTrackHeaders(),renderTrackLanes(),renderRegions()}function renderTrackHeaders(){let e=document.getElementById("track-headers-container");e.innerHTML='<div style="height: 30px; min-height: 30px; background: #1e293b; border-bottom: 1px solid #334155; display: flex; align-items: center; padding: 0 0.5rem; font-size: 10px; color: #94a3b8; font-weight: bold; letter-spacing: 1px;">TRACK LIST</div>',DAW.tracks.forEach(t=>{let a=document.createElement("div");a.id=`track-header-${t.id}`,a.className="track-header",activeTrackId===t.id?(a.style.borderLeft="4px solid #38bdf8",a.style.background="#1e293b"):(a.style.borderLeft="4px solid transparent",a.style.background="transparent"),a.onclick=e=>{e.target.closest("input")||e.target.closest("button")||selectTrack(t.id)},a.innerHTML=`
                    <div class="flex justify-between items-start">
                        <div class="font-bold text-xs truncate w-32" style="color: ${t.color}" title="${t.name}">${t.name}</div>
                        <div class="flex gap-1">
                            <button onclick="toggleRecord(${t.id})" id="btn-rec-${t.id}" class="w-6 h-6 rounded bg-slate-800 hover:bg-rose-500 text-[10px] text-white transition shadow"><i class="fa-solid fa-microphone"></i></button>
                            <button onclick="playIndividual(${t.id})" class="w-6 h-6 rounded bg-slate-800 hover:bg-sky-600 text-[10px] text-white transition"><i class="fa-solid fa-play"></i></button>
                            <button onclick="toggleMute(${t.id})" class="w-6 h-6 rounded ${t.muted?"bg-rose-600":"bg-slate-800"} text-[10px] text-white transition">M</button>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-2 mt-1" title="Volume">
                        <i class="fa-solid fa-volume-low text-[10px] text-slate-500"></i>
                        <input type="range" min="0" max="2" step="0.05" value="${t.volume}" oninput="updateFX(${t.id}, 'volume', this)" class="w-full h-1 bg-slate-700 appearance-none rounded cursor-pointer accent-sky-500">
                        <span id="val-volume-${t.id}" class="text-[8px] text-sky-400 font-bold w-8 text-right">${Math.round(100*t.volume)}%</span>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-x-2 gap-y-1 mt-1 p-1.5 bg-slate-900 rounded border border-slate-700 shadow-inner">
                        <div class="flex flex-col">
                            <div class="flex justify-between items-center"><span class="text-[8px] text-slate-400 font-bold tracking-widest">PAN</span><span id="val-pan-${t.id}" class="text-[8px] text-emerald-400 font-bold">${t.pan>0?"+"+t.pan:t.pan}</span></div>
                            <input type="range" min="-1" max="1" step="0.05" value="${t.pan}" oninput="updateFX(${t.id}, 'pan', this)" class="w-full accent-emerald-500 h-1 appearance-none bg-slate-800 rounded">
                        </div>
                        <div class="flex flex-col">
                            <div class="flex justify-between items-center"><span class="text-[8px] text-slate-400 font-bold tracking-widest">FILTER</span><span id="val-filter-${t.id}" class="text-[8px] text-sky-400 font-bold">${t.filter}</span></div>
                            <input type="range" min="0" max="100" step="1" value="${t.filter}" oninput="updateFX(${t.id}, 'filter', this)" class="w-full accent-sky-500 h-1 appearance-none bg-slate-800 rounded">
                        </div>
                        <div class="flex flex-col">
                            <div class="flex justify-between items-center"><span class="text-[8px] text-slate-400 font-bold tracking-widest">DELAY</span><span id="val-delay-${t.id}" class="text-[8px] text-amber-400 font-bold">${t.delay}</span></div>
                            <input type="range" min="0" max="1" step="0.05" value="${t.delay}" oninput="updateFX(${t.id}, 'delay', this)" class="w-full accent-amber-500 h-1 appearance-none bg-slate-800 rounded">
                        </div>
                        <div class="flex flex-col">
                            <div class="flex justify-between items-center"><span class="text-[8px] text-slate-400 font-bold tracking-widest">REVERB</span><span id="val-reverb-${t.id}" class="text-[8px] text-rose-400 font-bold">${t.reverb}</span></div>
                            <input type="range" min="0" max="1" step="0.05" value="${t.reverb}" oninput="updateFX(${t.id}, 'reverb', this)" class="w-full accent-rose-500 h-1 appearance-none bg-slate-800 rounded">
                        </div>
                        <div class="flex flex-col">
                            <div class="flex justify-between items-center"><span class="text-[8px] text-slate-400 font-bold tracking-widest text-sky-300">SPEED</span><span id="val-speed-${t.id}" class="text-[8px] text-indigo-400 font-bold">${t.speed||1}x</span></div>
                            <input type="range" min="0.5" max="2" step="0.05" value="${t.speed||1}" oninput="updateFX(${t.id}, 'speed', this)" class="w-full accent-indigo-400 h-1 appearance-none bg-slate-800 rounded">
                        </div>
                        <div class="flex flex-col justify-end">
                            <button onclick="togglePitch(${t.id})" class="text-[8px] w-full mt-0.5 py-0.5 rounded font-bold transition ${t.chipmunk?"bg-rose-600 text-white shadow-[0_0_5px_rgba(225,29,72,0.8)]":"bg-slate-800 text-slate-500 hover:bg-slate-700"}">${t.chipmunk?"ON (FALS)":"OFF (FIX)"}</button>
                        </div>
                    </div>
                    
                    <div class="mt-1"><input type="file" accept="audio/*" onclick="this.value=null" onchange="handleFileUpload(${t.id}, this)" class="text-[9px] w-full text-slate-500 file:bg-slate-800 file:border-0 file:text-slate-400 file:rounded file:px-1 file:cursor-pointer hover:file:bg-slate-700"></div>
                `,e.appendChild(a)})}function renderTrackLanes(){let e=document.getElementById("track-lanes-container");e.innerHTML="",document.getElementById("arranger-content").style.width=`${DAW.durationSec*DAW.pixelsPerSecond}px`,document.getElementById("bg-grid").style.backgroundSize=`${DAW.pixelsPerSecond}px 100%`,DAW.tracks.forEach(t=>{let a=document.createElement("div");a.className=`track-lane ${activeTrackId===t.id?"active":""}`,a.id=`lane-${t.id}`,a.onclick=()=>selectTrack(t.id),e.appendChild(a)}),renderRuler()}function renderRuler(){let e=document.getElementById("ruler");Array.from(e.children).forEach(e=>{e.id.includes("playhead")||e.remove()}),e.style.width=`${DAW.durationSec*DAW.pixelsPerSecond}px`;for(let t=0;t<=DAW.durationSec;t++){let a=document.createElement("div");if(a.className="tick-mark",a.style.left=`${t*DAW.pixelsPerSecond}px`,a.style.height=t%5==0?"15px":"8px",t%5==0){let n=document.createElement("div");n.className="tick-text",n.style.left=`${t*DAW.pixelsPerSecond}px`,n.innerText=`${t}s`,e.appendChild(n)}e.appendChild(a)}}function syncScroll(){document.getElementById("ruler").style.transform=`translateX(-${document.getElementById("arranger-scroll").scrollLeft}px)`}function renderRegions(){DAW.tracks.forEach(e=>{let t=document.getElementById(`lane-${e.id}`);t&&(t.innerHTML="",e.regions.forEach(a=>{let n=document.createElement("div"),i=selectedRegionInfo&&selectedRegionInfo.regionId===a.id;n.className=`audio-region group ${i?"selected":""}`;let r=Math.max(1,Math.floor(a.duration*DAW.pixelsPerSecond));n.style.left=`${Math.floor(a.startTime*DAW.pixelsPerSecond)}px`,n.style.width=`${r}px`,n.style.borderColor=e.color;let o=document.createElement("div");o.className="absolute top-0 left-0 w-full bg-black/60 text-[10px] px-1 text-white font-bold z-20 pointer-events-none truncate",o.innerText=e.name;let l=document.createElement("canvas");l.className="wave-canvas",l.width=Math.min(r,8e3),l.height=90;let d=document.createElement("div");d.className="cut-line";let s=document.createElement("div");s.className="btn-delete-region",s.innerHTML='<i class="fa-solid fa-times"></i>',s.onmousedown=t=>{t.stopPropagation(),deleteRegion(e.id,a.id)};let c=document.createElement("div");c.className="btn-reverse-region",c.innerHTML='<i class="fa-solid fa-backward-step"></i>',c.title="Reverse Audio",c.onmousedown=t=>{t.stopPropagation(),reverseRegion(e.id,a.id)};let u=document.createElement("div");u.className="trim-handle left",u.onmousedown=t=>{t.stopPropagation(),startTrimRegion(t,e.id,a.id,"left")};let f=document.createElement("div");f.className="trim-handle right",f.onmousedown=t=>{t.stopPropagation(),startTrimRegion(t,e.id,a.id,"right")},n.append(o,l,d,c,s,u,f);let p=document.createElement("div");p.className="fade-handle left",p.style.left=`${(a.fadeIn||0)*DAW.pixelsPerSecond}px`,p.onmousedown=t=>{t.stopPropagation(),startFadeRegion(t,e.id,a.id,"in")},n.appendChild(p);let m=document.createElement("div");m.className="fade-handle right",m.style.right=`${(a.fadeOut||0)*DAW.pixelsPerSecond}px`,m.onmousedown=t=>{t.stopPropagation(),startFadeRegion(t,e.id,a.id,"out")},n.appendChild(m),a.automation&&a.automation.forEach(t=>{let i=document.createElement("div");i.className="auto-node",i.style.left=`${t.t/a.duration*r}px`,i.style.top=`${(1-t.v)*90}px`,i.onmousedown=n=>{if(n.stopPropagation(),2===n.detail){a.automation=a.automation.filter(e=>e.id!==t.id),renderRegions(),"function"==typeof saveState&&saveState();return}startDragNode(n,e.id,a.id,t.id)},n.appendChild(i)}),t.appendChild(n),setTimeout(()=>drawWaveform(a,l,e.color),10),n.addEventListener("mousemove",e=>{let t=n.getBoundingClientRect();d.style.left=`${e.clientX-t.left}px`}),n.addEventListener("dblclick",t=>{t.stopPropagation();let i=n.getBoundingClientRect();splitRegion(e.id,a.id,(t.clientX-i.left)/DAW.pixelsPerSecond)}),n.addEventListener("mousedown",t=>{if(t.stopPropagation(),t.shiftKey){let i=n.getBoundingClientRect(),r=t.clientX-i.left,o=t.clientY-i.top,l=r/i.width*a.duration,d=1-o/i.height;a.automation||(a.automation=[]),a.automation.push({id:Date.now(),t:l,v:d}),renderRegions(),"function"==typeof saveState&&saveState();return}document.querySelectorAll(".audio-region").forEach(e=>e.classList.remove("selected")),n.classList.add("selected"),selectedRegionInfo={trackId:e.id,regionId:a.id},"function"==typeof startDragRegion&&startDragRegion(t,e.id,a.id,n)})}))})}function drawWaveform(e,t,a){if(t.isConnected&&0!==t.width)try{let n=t.getContext("2d"),i=e.buffer.getChannelData(0),r=Math.floor(e.startOffset*e.buffer.sampleRate),o=e.duration*e.buffer.sampleRate/t.width,l=t.height/2;n.fillStyle=a,n.clearRect(0,0,t.width,t.height);for(let d=0;d<t.width;d++){let s=0,c=0,u=Math.floor(r+d*o),f=Math.floor(r+(d+1)*o);u===f&&f++;for(let p=u;p<f;p++)p<i.length&&(i[p]<s&&(s=i[p]),i[p]>c&&(c=i[p]));n.fillRect(d,(1+s)*l,1,Math.max(1,(c-s)*l))}let m=e.fadeIn||0,g=e.fadeOut||0;if(n.fillStyle="rgba(0,0,0,0.6)",m>0){let $=m*DAW.pixelsPerSecond;n.beginPath(),n.moveTo(0,0),n.lineTo($,0),n.lineTo(0,t.height),n.fill(),n.beginPath(),n.moveTo(0,t.height),n.lineTo($,t.height),n.lineTo(0,0),n.fill()}if(g>0){let y=g*DAW.pixelsPerSecond,h=t.width-y;n.beginPath(),n.moveTo(t.width,0),n.lineTo(h,0),n.lineTo(t.width,t.height),n.fill(),n.beginPath(),n.moveTo(t.width,t.height),n.lineTo(h,t.height),n.lineTo(t.width,0),n.fill()}if(e.automation&&e.automation.length>0){let D=[...e.automation].sort((e,t)=>e.t-t.t);n.strokeStyle="white",n.lineWidth=2,n.beginPath(),n.moveTo(0,t.height-D[0].v*t.height),D.forEach(a=>{let i=a.t/e.duration*t.width,r=t.height-a.v*t.height;n.lineTo(i,r)}),n.lineTo(t.width,t.height-D[D.length-1].v*t.height),n.stroke()}}catch(v){console.error("Canvas Render Error:",v)}}let activeTrackId=null;function selectTrack(e){activeTrackId=e,document.querySelectorAll(".track-header").forEach(e=>{e.style.borderLeft="4px solid transparent",e.style.background="transparent"}),document.querySelectorAll(".track-lane").forEach(e=>{e.style.background="transparent"});let t=document.getElementById(`track-header-${e}`),a=document.getElementById(`lane-${e}`);t&&(t.style.borderLeft="4px solid #38bdf8",t.style.background="#1e293b"),a&&(a.style.background="rgba(56, 189, 248, 0.05)")}function startDragPlayhead(e){DAW.isPlaying||(updatePlayheadFromMouse(e),document.addEventListener("mousemove",dragPlayhead),document.addEventListener("mouseup",stopDragPlayhead))}function dragPlayhead(e){updatePlayheadFromMouse(e)}function stopDragPlayhead(){document.removeEventListener("mousemove",dragPlayhead),document.removeEventListener("mouseup",stopDragPlayhead)}function updatePlayheadFromMouse(e){DAW.playheadSec=Math.max(0,(e.clientX-document.getElementById("ruler").getBoundingClientRect().left)/DAW.pixelsPerSecond),updatePlayheadUI()}let dragInfo=null;function startDragRegion(e,t,a,n){dragInfo={tId:t,rId:a,el:n,startX:e.clientX,startY:e.clientY,initTime:DAW.tracks.find(e=>e.id===t).regions.find(e=>e.id===a).startTime,isDragging:!1},document.addEventListener("mousemove",moveRegion),document.addEventListener("mouseup",dropRegion)}function moveRegion(e){if(!dragInfo)return;if(!dragInfo.isDragging){if(!(Math.abs(e.clientX-dragInfo.startX)>3||Math.abs(e.clientY-dragInfo.startY)>3))return;dragInfo.isDragging=!0,dragInfo.el.style.pointerEvents="none",dragInfo.el.style.zIndex="100"}let t=DAW.tracks.find(e=>e.id===dragInfo.tId).regions.find(e=>e.id===dragInfo.rId),a=dragInfo.initTime+(e.clientX-dragInfo.startX)/DAW.pixelsPerSecond,n=10/DAW.pixelsPerSecond,i=null,r=n,o=[DAW.playheadSec];if(DAW.loopEnabled&&o.push(DAW.loopStart,DAW.loopEnd),DAW.tracks.forEach(e=>{e.regions.forEach(e=>{e.id!==dragInfo.rId&&(o.push(e.startTime),o.push(e.startTime+e.duration))})}),o.forEach(e=>{let n=Math.abs(a-e);n<r&&(r=n,i=e);let o=Math.abs(a+t.duration-e);o<r&&(r=o,i=e-t.duration)}),null!==i)a=i;else if(DAW.snap){let l=60/DAW.bpm,d=l/4;a=Math.round(a/d)*d}t.startTime=Math.max(0,a),dragInfo.el.style.left=`${t.startTime*DAW.pixelsPerSecond}px`;let s=e.clientY-dragInfo.startY;dragInfo.el.style.transform=`translateY(${s}px)`}function dropRegion(e){if(document.removeEventListener("mousemove",moveRegion),document.removeEventListener("mouseup",dropRegion),dragInfo){if(dragInfo.isDragging){dragInfo.el.style.pointerEvents="auto",dragInfo.el.style.transform="none",dragInfo.el.style.zIndex="";let t=document.elementFromPoint(e.clientX,e.clientY),a=t?t.closest(".track-lane"):null;if(a){let n=parseInt(a.id.replace("lane-",""));if(n&&n!==dragInfo.tId){let i=DAW.tracks.find(e=>e.id===dragInfo.tId),r=DAW.tracks.find(e=>e.id===n),o=i.regions.findIndex(e=>e.id===dragInfo.rId);if(o>-1){let l=i.regions.splice(o,1)[0];r.regions.push(l)}}}renderRegions(),"function"==typeof saveState&&saveState()}dragInfo=null}}function splitRegion(e,t,a){let n=DAW.tracks.find(t=>t.id===e),i=n.regions.findIndex(e=>e.id===t),r=n.regions[i];a<.1||a>r.duration-.1||(n.regions.splice(i,1,{id:Date.now()+1,buffer:r.buffer,startOffset:r.startOffset,startTime:r.startTime,duration:a},{id:Date.now()+2,buffer:r.buffer,startOffset:r.startOffset+a,startTime:r.startTime+a,duration:r.duration-a}),renderRegions(),saveState())}function deleteRegion(e,t){DAW.tracks.find(t=>t.id===e).regions=DAW.tracks.find(t=>t.id===e).regions.filter(e=>e.id!==t),renderRegions(),saveState()}let trimInfo=null;function startTrimRegion(e,t,a,n){let i=DAW.tracks.find(e=>e.id===t).regions.find(e=>e.id===a);trimInfo={tId:t,rId:a,side:n,startX:e.clientX,initSt:i.startTime,initDur:i.duration,initOff:i.startOffset,maxD:i.buffer.duration},document.addEventListener("mousemove",trimRegion),document.addEventListener("mouseup",stopTrimRegion)}function trimRegion(e){if(!trimInfo)return;let t=(e.clientX-trimInfo.startX)/DAW.pixelsPerSecond,a=DAW.tracks.find(e=>e.id===trimInfo.tId).regions.find(e=>e.id===trimInfo.rId);if("right"===trimInfo.side)a.duration=Math.min(trimInfo.maxD-a.startOffset,Math.max(.1,trimInfo.initDur+t));else{let n=trimInfo.initDur-t,i=trimInfo.initSt+t,r=trimInfo.initOff+t;n<.1&&(i+=n-.1,r+=n-.1,n=.1),r<0&&(i-=r,n+=r,r=0),i<0&&(r-=i,n+=i,i=0),a.duration=n,a.startTime=i,a.startOffset=r}renderRegions()}function stopTrimRegion(){document.removeEventListener("mousemove",trimRegion),document.removeEventListener("mouseup",stopTrimRegion),trimInfo&&(saveState(),trimInfo=null)}function toggleMute(e){DAW.tracks.find(t=>t.id===e).muted=!DAW.tracks.find(t=>t.id===e).muted,renderTrackHeaders()}function playIndividual(e){initAudio(),DAW.tracks.forEach(t=>t.muted=t.id!==e),renderTrackHeaders();let t=DAW.tracks.find(t=>t.id===e);t.regions.length>0&&(DAW.playheadSec=t.regions.reduce((e,t)=>e.startTime<t.startTime?e:t).startTime,updatePlayheadUI()),DAW.isPlaying||playGlobal()}function updateFX(e,t,a){let n=DAW.tracks.find(t=>t.id===e),i=parseFloat(a.value);"pan"===t&&.06>=Math.abs(i)&&(i=0),"filter"===t&&3>=Math.abs(i-50)&&(i=50),"speed"===t&&.06>=Math.abs(i-1)&&(i=1),"volume"===t&&.06>=Math.abs(i-1)&&(i=1),"delay"===t&&i<=.03&&(i=0),"reverb"===t&&i<=.03&&(i=0),a.value=i,n[t]=i;let r=document.getElementById(`val-${t}-${e}`);r&&("pan"===t?r.innerText=i>0?`+${i.toFixed(2)}`:0===i?"0":i.toFixed(2):"speed"===t?r.innerText=`${i.toFixed(2)}x`:"volume"===t?r.innerText=`${Math.round(100*i)}%`:"filter"===t?r.innerText=i:r.innerText=0===i?"0":i.toFixed(2)),activeSources.forEach(a=>{a.trackId===e&&("volume"===t&&a.gainNode&&(a.gainNode.gain.value=n.volume),"pan"===t&&a.pannerNode&&(a.pannerNode.pan.value=0===n.pan?.001:n.pan),"delay"===t&&a.delayGainNode&&(a.delayGainNode.gain.value=n.delay),"reverb"===t&&a.reverbGainNode&&(a.reverbGainNode.gain.value=n.reverb),"speed"===t&&a.source&&(a.source.playbackRate.value=n.speed),"filter"===t&&a.filterNode&&(n.filter<50?(a.filterNode.type="lowpass",a.filterNode.frequency.value=200+n.filter/50*2e4):n.filter>50?(a.filterNode.type="highpass",a.filterNode.frequency.value=(n.filter-50)/50*5e3):(a.filterNode.type="lowpass",a.filterNode.frequency.value=24e3)))})}function togglePitch(e){let t=DAW.tracks.find(t=>t.id===e);t.chipmunk=!t.chipmunk,renderTrackHeaders(),activeSources.forEach(a=>{a.trackId===e&&a.source&&(a.source.preservesPitch=!t.chipmunk)}),"function"==typeof saveState&&saveState()}function playGlobal(){if(initAudio(),DAW.isPlaying){stopGlobal();return}if(DAW.isPlaying=!0,document.getElementById("btn-master-play").innerHTML='<i class="fa-solid fa-pause"></i>',document.getElementById("btn-master-play").classList.replace("bg-emerald-600","bg-amber-500"),playStartTime=DAW.audioCtx.currentTime-DAW.playheadSec,DAW.tracks.forEach(e=>{e.muted||e.regions.forEach(t=>{if(t.startTime+t.duration>DAW.playheadSec){let a=DAW.audioCtx.createBufferSource();a.buffer=t.buffer,a.playbackRate.value=e.speed||1,a.preservesPitch=!e.chipmunk;let n=t.startTime,i=t.startOffset,r=t.duration;if(DAW.playheadSec>t.startTime){let o=DAW.playheadSec-t.startTime;i+=o,r-=o,n=DAW.playheadSec}if(r<=0)return;let l=DAW.audioCtx.createGain(),d=t.fadeIn||0,s=t.fadeOut||0,c=Math.max(0,DAW.playheadSec-t.startTime),u=DAW.audioCtx.currentTime+(n-DAW.playheadSec),f=1;c<d?f=c/d:c>t.duration-s&&(f=(t.duration-c)/s),l.gain.setValueAtTime(f,DAW.audioCtx.currentTime),d>0&&c<d&&(l.gain.setValueAtTime(f,u),l.gain.linearRampToValueAtTime(1,u+(d-c))),s>0&&(c<t.duration-s?(l.gain.setValueAtTime(1,u+(t.duration-s-c)),l.gain.linearRampToValueAtTime(0,u+(t.duration-c))):(l.gain.setValueAtTime(f,u),l.gain.linearRampToValueAtTime(0,u+(t.duration-c))));let p=DAW.audioCtx.createGain();if(p.gain.setValueAtTime(1,DAW.audioCtx.currentTime),t.automation&&t.automation.length>0){p.gain.cancelScheduledValues(DAW.audioCtx.currentTime);let m=[...t.automation].sort((e,t)=>e.t-t.t),g=DAW.audioCtx.currentTime+(t.startTime-DAW.playheadSec);p.gain.setValueAtTime(m[0].v,DAW.audioCtx.currentTime),m.forEach(e=>{let t=g+e.t;t>=DAW.audioCtx.currentTime?p.gain.linearRampToValueAtTime(e.v,t):p.gain.setValueAtTime(e.v,DAW.audioCtx.currentTime)})}let $=DAW.audioCtx.createBiquadFilter();e.filter<50?($.type="lowpass",$.frequency.value=200+e.filter/50*2e4):e.filter>50?($.type="highpass",$.frequency.value=(e.filter-50)/50*5e3):($.type="lowpass",$.frequency.value=24e3);let y=DAW.audioCtx.createStereoPanner();y.pan.value=0===e.pan?.001:e.pan;let h=DAW.audioCtx.createGain();h.gain.value=e.volume;let D=DAW.audioCtx.createDelay();D.delayTime.value=.35;let v=DAW.audioCtx.createGain();v.gain.value=.4;let A=DAW.audioCtx.createGain();A.gain.value=e.delay,D.connect(v).connect(D);let b=DAW.audioCtx.createConvolver();b.buffer=DAW.reverbIR;let x=DAW.audioCtx.createGain();x.gain.value=e.reverb,a.connect(l).connect(p).connect($).connect(y).connect(h),h.connect(DAW.masterGain),h.connect(D).connect(A).connect(DAW.masterGain),h.connect(b).connect(x).connect(DAW.masterGain),a.start(DAW.audioCtx.currentTime+(n-DAW.playheadSec),i,r),activeSources.push({source:a,gainNode:h,pannerNode:y,filterNode:$,delayGainNode:A,reverbGainNode:x,trackId:e.id})}})}),DAW.metronome){let e=60/DAW.bpm;for(let t=0;t*e<DAW.durationSec;t++){let a=t*e;if(a>=DAW.playheadSec){let n=DAW.audioCtx.createOscillator(),i=DAW.audioCtx.createGain();n.frequency.value=t%4==0?1200:800,n.type="sine",n.connect(i).connect(DAW.masterGain);let r=DAW.audioCtx.currentTime+(a-DAW.playheadSec);n.start(r),i.gain.setValueAtTime(0,r),i.gain.linearRampToValueAtTime(.8,r+.005),i.gain.exponentialRampToValueAtTime(.001,r+.05),n.stop(r+.06),activeSources.push({source:n})}}}animatePlayhead()}function stopGlobal(){DAW.isPlaying=!1,document.getElementById("btn-master-play").innerHTML='<i class="fa-solid fa-play ml-1"></i>',document.getElementById("btn-master-play").classList.replace("bg-amber-500","bg-emerald-600"),activeSources.forEach(e=>{try{e.source.stop()}catch(t){}}),activeSources=[],cancelAnimationFrame(animationFrame),isRecording&&micRecorder&&"inactive"!==micRecorder.state&&micRecorder.stop()}function animatePlayhead(){if(DAW.isPlaying){if(DAW.playheadSec=DAW.audioCtx.currentTime-playStartTime,DAW.loopEnabled&&DAW.loopEnd>DAW.loopStart&&DAW.playheadSec>=DAW.loopEnd){activeSources.forEach(e=>{try{e.source.stop()}catch(t){}}),activeSources=[],DAW.playheadSec=DAW.loopStart,DAW.isPlaying=!1,playGlobal();return}updatePlayheadUI(),animationFrame=requestAnimationFrame(animatePlayhead)}}function updatePlayheadUI(){let e=DAW.playheadSec*DAW.pixelsPerSecond;document.getElementById("playhead-top").style.left=`${e}px`,document.getElementById("playhead-main").style.left=`${e}px`,document.getElementById("time-display").innerText=`${Math.floor(DAW.playheadSec/60).toString().padStart(2,"0")}:${(DAW.playheadSec%60).toFixed(1).padStart(4,"0")}`}let mediaRecorder=null,recordedChunks=[];function exportMix(){initAudio(),DAW.isPlaying&&stopGlobal();let e=0;if(DAW.tracks.forEach(t=>{t.regions.forEach(t=>{let a=t.startTime+t.duration;a>e&&(e=a)})}),0===e)return alert("Project kosong, Bro! Tidak ada audio yang bisa di-save.");DAW.durationSec=Math.ceil(e)+2,renderTrackLanes(),renderRegions(),alert(`Merekam Audio selama ${DAW.durationSec} detik! Biarkan lagu berputar sampai berhenti otomatis.`),DAW.playheadSec=0,updatePlayheadUI(),recordedChunks=[];try{(mediaRecorder=new MediaRecorder(DAW.destStream.stream)).ondataavailable=e=>{e.data.size>0&&recordedChunks.push(e.data)},mediaRecorder.onstop=()=>{let e=document.createElement("a");e.href=URL.createObjectURL(new Blob(recordedChunks,{type:"audio/webm"})),e.download=`Aries_Mix_${Date.now()}.webm`,document.body.appendChild(e),e.click(),document.body.removeChild(e);let t=document.getElementById("btn-export");t.innerHTML='<i class="fa-solid fa-download"></i> SAVE',t.classList.replace("bg-rose-600","bg-indigo-600")},document.getElementById("btn-export").innerHTML='<i class="fa-solid fa-circle text-rose-300"></i> REC',document.getElementById("btn-export").classList.replace("bg-indigo-600","bg-rose-600"),mediaRecorder.start(),playGlobal();let t=setInterval(()=>{DAW.isPlaying||(mediaRecorder.stop(),clearInterval(t))},1e3)}catch(a){alert("Browser tidak mendukung perekaman internal.")}}function openHelp(){document.getElementById("help-modal").classList.remove("hidden")}function closeHelp(){document.getElementById("help-modal").classList.add("hidden")}window.addEventListener("keydown",e=>{if("input"!==e.target.tagName.toLowerCase()){if("Space"===e.code){e.preventDefault(),DAW.isPlaying?stopGlobal():playGlobal();return}if(e.ctrlKey&&("z"===e.key||"Z"===e.key)){"function"==typeof undo&&undo();return}if(e.ctrlKey&&("y"===e.key||"Y"===e.key||e.shiftKey&&("z"===e.key||"Z"===e.key))){"function"==typeof redo&&redo();return}if(e.ctrlKey&&("v"===e.key||"V"===e.key)){if(!clipboardRegionData)return;let t=activeTrackId||clipboardRegionData.originalTrackId,a=DAW.tracks.find(e=>e.id===t);if(a){let n=Object.assign({},clipboardRegionData);n.id=Date.now(),n.startTime=DAW.playheadSec,a.regions.push(n),renderRegions(),"function"==typeof saveState&&saveState()}return}if(selectedRegionInfo&&(("Delete"===e.key||"Backspace"===e.key)&&(deleteRegion(selectedRegionInfo.trackId,selectedRegionInfo.regionId),selectedRegionInfo=null,document.querySelectorAll(".audio-region").forEach(e=>e.classList.remove("selected"))),e.ctrlKey&&("c"===e.key||"C"===e.key))){let i=DAW.tracks.find(e=>e.id===selectedRegionInfo.trackId),r=i.regions.find(e=>e.id===selectedRegionInfo.regionId);if(r){(clipboardRegionData=Object.assign({},r)).originalTrackId=i.id;let o=document.getElementById(`region-ui-${r.id}`);o&&(o.style.opacity="0.3",setTimeout(()=>o.style.opacity="1",150))}}}});let stateHistory=[],historyIndex=-1;const MAX_HISTORY=30;function saveState(){historyIndex<stateHistory.length-1&&(stateHistory=stateHistory.slice(0,historyIndex+1));let e=DAW.tracks.map(e=>({id:e.id,name:e.name,color:e.color,volume:e.volume,muted:e.muted,pan:e.pan,filter:e.filter,delay:e.delay,reverb:e.reverb,speed:e.speed||1,chipmunk:e.chipmunk||!1,regions:e.regions.map(e=>({id:e.id,buffer:e.buffer,startOffset:e.startOffset,startTime:e.startTime,duration:e.duration,fadeIn:e.fadeIn||0,fadeOut:e.fadeOut||0,automation:e.automation?e.automation.map(e=>({...e})):[]}))}));stateHistory.push(e),stateHistory.length>30?stateHistory.shift():historyIndex++}function restoreState(e){if(e<0||e>=stateHistory.length)return;let t=stateHistory[e];DAW.tracks=t.map(e=>({...e,regions:e.regions.map(e=>({...e}))})),selectedRegionInfo=null,document.querySelectorAll(".audio-region").forEach(e=>e.classList.remove("selected")),renderTrackHeaders(),renderRegions()}let fadeInfo=null;function startFadeRegion(e,t,a,n){let i=DAW.tracks.find(e=>e.id===t),r=i.regions.find(e=>e.id===a);fadeInfo={tId:t,rId:a,type:n,startX:e.clientX,initFade:"in"===n?r.fadeIn||0:r.fadeOut||0},document.addEventListener("mousemove",dragFadeRegion),document.addEventListener("mouseup",stopFadeRegion)}function dragFadeRegion(e){if(!fadeInfo)return;let t=(e.clientX-fadeInfo.startX)/DAW.pixelsPerSecond,a=DAW.tracks.find(e=>e.id===fadeInfo.tId).regions.find(e=>e.id===fadeInfo.rId);if("in"===fadeInfo.type){let n=fadeInfo.initFade+t;n<0&&(n=0),n>a.duration-(a.fadeOut||0)&&(n=a.duration-(a.fadeOut||0)),a.fadeIn=n}else{let i=fadeInfo.initFade-t;i<0&&(i=0),i>a.duration-(a.fadeIn||0)&&(i=a.duration-(a.fadeIn||0)),a.fadeOut=i}renderRegions()}function stopFadeRegion(){document.removeEventListener("mousemove",dragFadeRegion),document.removeEventListener("mouseup",stopFadeRegion),fadeInfo&&(saveState(),fadeInfo=null)}function undo(){historyIndex>0&&restoreState(--historyIndex)}function redo(){historyIndex<stateHistory.length-1&&restoreState(++historyIndex)}function updateGrid(){let e=60/DAW.bpm,t=e*DAW.pixelsPerSecond;document.getElementById("bg-grid").style.backgroundSize=`${t}px 100%`}DAW.bpm=120,DAW.snap=!1,DAW.metronome=!1,document.getElementById("bpm-input").addEventListener("change",e=>{DAW.bpm=parseInt(e.target.value)||120,updateGrid()}),document.getElementById("btn-snap").addEventListener("click",e=>{DAW.snap=!DAW.snap,e.currentTarget.classList.toggle("bg-sky-600"),e.currentTarget.classList.toggle("text-white"),e.currentTarget.classList.toggle("bg-slate-700"),e.currentTarget.classList.toggle("text-slate-300")}),document.getElementById("btn-metronome").addEventListener("click",e=>{DAW.metronome=!DAW.metronome,e.currentTarget.classList.toggle("bg-amber-500"),e.currentTarget.classList.toggle("text-white"),e.currentTarget.classList.toggle("bg-slate-700"),e.currentTarget.classList.toggle("text-slate-300")});let isRecording=!1,recordingTrackId=null,micRecorder=null,micChunks=[],recordStartTime=0;async function toggleRecord(e){if(initAudio(),isRecording){stopGlobal();return}try{let t=await navigator.mediaDevices.getUserMedia({audio:!0});micRecorder=new MediaRecorder(t),micChunks=[],recordingTrackId=e,recordStartTime=DAW.playheadSec,micRecorder.ondataavailable=e=>{e.data.size>0&&micChunks.push(e.data)},micRecorder.onstop=async()=>{let e=new Blob(micChunks,{type:"audio/webm"}),a=await e.arrayBuffer();try{let n=await DAW.audioCtx.decodeAudioData(a),i=DAW.tracks.find(e=>e.id===recordingTrackId);i&&(i.regions.push({id:Date.now(),buffer:n,startOffset:0,startTime:recordStartTime,duration:n.duration}),recordStartTime+n.duration>DAW.durationSec&&(DAW.durationSec=Math.ceil(recordStartTime+n.duration)+10,renderTrackLanes()),renderRegions(),saveState())}catch(r){console.error(r),alert("Gagal memproses hasil rekaman suara.")}let o=document.getElementById(`btn-rec-${recordingTrackId}`);o&&(o.classList.remove("bg-rose-600","animate-pulse"),o.classList.add("bg-slate-800")),isRecording=!1,recordingTrackId=null,t.getTracks().forEach(e=>e.stop())},micRecorder.start(),isRecording=!0;let a=document.getElementById(`btn-rec-${e}`);a&&(a.classList.remove("bg-slate-800"),a.classList.add("bg-rose-600","animate-pulse")),DAW.isPlaying||playGlobal()}catch(n){alert("Gagal merekam! Pastikan kamu memberi izin Microphone pada Browser.")}}function bufferToWav(e){let t=e.numberOfChannels,a=e.length*t*2+44,n=new ArrayBuffer(a),i=new DataView(n),r=[],o,l,d=0,s=0;function c(e){i.setUint16(d,e,!0),d+=2}function u(e){i.setUint32(d,e,!0),d+=4}for(u(1179011410),u(a-8),u(1163280727),u(544501094),u(16),c(1),c(t),u(e.sampleRate),u(2*e.sampleRate*t),c(2*t),c(16),u(1635017060),u(a-s-4),o=0;o<e.numberOfChannels;o++)r.push(e.getChannelData(o));for(;s<e.length;){for(o=0;o<t;o++)l=(.5+(l=Math.max(-1,Math.min(1,r[o][s])))<0?32768*l:32767*l)|0,i.setInt16(d,l,!0),d+=2;s++}return new Blob([n],{type:"audio/wav"})}async function exportAudio(){let e=document.getElementById("export-format").value;initAudio(),DAW.isPlaying&&stopGlobal();let t=0;if(DAW.tracks.forEach(e=>e.regions.forEach(e=>{e.startTime+e.duration>t&&(t=e.startTime+e.duration)})),0===t)return alert("Project kosong! Tidak ada yang bisa di-export.");if(DAW.durationSec=Math.ceil(t+2),renderTrackLanes(),renderRegions(),"wav"===e){alert("Memulai Render WAV (Kualitas Studio)... Proses ini instan dan tidak memutar lagu.");let a=DAW.audioCtx.sampleRate,n=new OfflineAudioContext(2,a*DAW.durationSec,a);DAW.tracks.forEach(e=>{e.muted||e.regions.forEach(t=>{let a=n.createBufferSource();a.buffer=t.buffer,a.playbackRate.value=e.speed||1,a.preservesPitch=!e.chipmunk;let i=n.createBiquadFilter();e.filter<50?(i.type="lowpass",i.frequency.value=200+e.filter/50*2e4):e.filter>50?(i.type="highpass",i.frequency.value=(e.filter-50)/50*5e3):(i.type="lowpass",i.frequency.value=24e3);let r=n.createStereoPanner();r.pan.value=0===e.pan?.001:e.pan;let o=n.createGain();o.gain.value=e.volume;let l=n.createDelay();l.delayTime.value=.35;let d=n.createGain();d.gain.value=.4;let s=n.createGain();s.gain.value=e.delay,l.connect(d).connect(l);let c=n.createConvolver();c.buffer=DAW.reverbIR;let u=n.createGain();u.gain.value=e.reverb;let f=n.createGain();f.gain.setValueAtTime(0,0);let p=t.fadeIn||0,m=t.fadeOut||0;p>0?(f.gain.setValueAtTime(0,t.startTime),f.gain.linearRampToValueAtTime(1,t.startTime+p)):f.gain.setValueAtTime(1,t.startTime),m>0?(f.gain.setValueAtTime(1,t.startTime+t.duration-m),f.gain.linearRampToValueAtTime(0,t.startTime+t.duration)):(f.gain.setValueAtTime(1,t.startTime+t.duration-.01),f.gain.linearRampToValueAtTime(0,t.startTime+t.duration));let g=n.createGain();if(g.gain.setValueAtTime(1,0),t.automation&&t.automation.length>0){g.gain.cancelScheduledValues(0);let $=[...t.automation].sort((e,t)=>e.t-t.t);g.gain.setValueAtTime($[0].v,t.startTime),$.forEach(e=>{g.gain.linearRampToValueAtTime(e.v,t.startTime+e.t)})}a.connect(f).connect(g).connect(i).connect(r).connect(o),o.connect(n.destination),o.connect(l).connect(s).connect(n.destination),o.connect(c).connect(u).connect(n.destination),a.start(t.startTime,t.startOffset,t.duration)})});let i=await n.startRendering(),r=bufferToWav(i),o=document.createElement("a");o.href=URL.createObjectURL(r),o.download=`Aries_Mix_${Date.now()}.wav`,document.body.appendChild(o),o.click(),document.body.removeChild(o)}else if("webm"===e){alert(`Merekam audio terkompresi selama ${DAW.durationSec} detik! Biarkan lagu berputar sampai berhenti otomatis.`),DAW.playheadSec=0,updatePlayheadUI();let l=[];try{let d=new MediaRecorder(DAW.destStream.stream);d.ondataavailable=e=>{e.data.size>0&&l.push(e.data)},d.onstop=()=>{let e=document.createElement("a");e.href=URL.createObjectURL(new Blob(l,{type:"audio/webm"})),e.download=`Aries_Mix_${Date.now()}.webm`,document.body.appendChild(e),e.click(),document.body.removeChild(e);let t=document.getElementById("btn-export");t.innerHTML='<i class="fa-solid fa-file-audio"></i> EXPORT',t.classList.replace("bg-indigo-600","bg-rose-600")},document.getElementById("btn-export").innerHTML='<i class="fa-solid fa-circle text-rose-300"></i> REC',document.getElementById("btn-export").classList.replace("bg-rose-600","bg-indigo-600"),d.start(),playGlobal();let s=setInterval(()=>{DAW.isPlaying||(d.stop(),clearInterval(s))},1e3)}catch(c){alert("Browser tidak mendukung perekaman internal.")}}}async function saveProject(){alert("Mengepak file Project... Mohon tunggu karena data audio sedang disalin.");let e=[],t={bpm:DAW.bpm,durationSec:DAW.durationSec,tracks:[]},a=async t=>{let a=e.findIndex(e=>e.buffer===t);if(-1===a){let n=bufferToWav(t),i=await new Promise(e=>{let t=new FileReader;t.onloadend=()=>e(t.result),t.readAsDataURL(n)});e.push({buffer:t,base64:i}),a=e.length-1}return a};for(let n of DAW.tracks){let i={id:n.id,name:n.name,color:n.color,volume:n.volume,muted:n.muted,pan:n.pan,filter:n.filter,delay:n.delay,reverb:n.reverb,speed:n.speed||1,chipmunk:n.chipmunk||!1,regions:[]};for(let r of n.regions){let o=await a(r.buffer);i.regions.push({id:r.id,startOffset:r.startOffset,startTime:r.startTime,duration:r.duration,fadeIn:r.fadeIn||0,fadeOut:r.fadeOut||0,bufferIndex:o,automation:r.automation?r.automation.map(e=>({...e})):[]})}t.tracks.push(i)}t.audioData=e.map(e=>e.base64);let l=new Blob([JSON.stringify(t)],{type:"application/json"}),d=document.createElement("a");d.href=URL.createObjectURL(l),d.download=`My_Project_${Date.now()}.aries`,document.body.appendChild(d),d.click(),document.body.removeChild(d)}function loadProject(e){let t=e.files[0];if(!t)return;let a=new FileReader;a.onload=async t=>{try{alert("Memuat Project... Sedang membangun ulang struktur audio."),initAudio();let a=JSON.parse(t.target.result),n=[];for(let i of a.audioData){let r=await fetch(i),o=await r.arrayBuffer(),l=await DAW.audioCtx.decodeAudioData(o);n.push(l)}DAW.bpm=a.bpm||120,DAW.durationSec=a.durationSec||60,document.getElementById("bpm-input").value=DAW.bpm,updateGrid(),DAW.tracks=a.tracks.map(e=>{let t=new Track(e.id,e.name,e.color);return t.volume=e.volume,t.muted=e.muted,t.pan=e.pan||0,t.filter=e.filter||50,t.delay=e.delay||0,t.reverb=e.reverb||0,t.speed=e.speed||1,t.chipmunk=e.chipmunk||!1,t.regions=e.regions.map(e=>({id:e.id,buffer:n[e.bufferIndex],startOffset:e.startOffset,startTime:e.startTime,duration:e.duration,fadeIn:e.fadeIn||0,fadeOut:e.fadeOut||0,automation:e.automation?e.automation.map(e=>({...e})):[]})),t}),renderTrackHeaders(),renderTrackLanes(),renderRegions(),stateHistory=[],historyIndex=-1,saveState(),alert("Project berhasil dimuat sepenuhnya!")}catch(d){console.error(d),alert("Gagal memuat project. File mungkin rusak atau tidak valid.")}e.value=""},a.readAsText(t)}function toggleLoop(){DAW.loopEnabled=!DAW.loopEnabled;let e=document.getElementById("btn-loop"),t=document.getElementById("loop-region");DAW.loopEnabled?(e.classList.replace("bg-slate-700","bg-purple-600"),e.classList.replace("text-slate-300","text-white"),t||(createLoopUI(),t=document.getElementById("loop-region")),t.style.display="block",renderLoopUI()):(e.classList.replace("bg-purple-600","bg-slate-700"),e.classList.replace("text-white","text-slate-300"),t&&(t.style.display="none"))}function createLoopUI(){let e=document.getElementById("arranger-content"),t=document.createElement("div");t.id="loop-region";let a=document.createElement("div");a.className="loop-bar",a.onmousedown=e=>startDragLoop(e,"bar");let n=document.createElement("div");n.className="loop-handle left",n.onmousedown=e=>startDragLoop(e,"left");let i=document.createElement("div");i.className="loop-handle right",i.onmousedown=e=>startDragLoop(e,"right"),t.appendChild(a),t.appendChild(n),t.appendChild(i),e.appendChild(t)}function renderLoopUI(){let e=document.getElementById("loop-region");if(!e||!DAW.loopEnabled)return;let t=DAW.loopStart*DAW.pixelsPerSecond,a=(DAW.loopEnd-DAW.loopStart)*DAW.pixelsPerSecond;e.style.left=`${t}px`,e.style.width=`${Math.max(10,a)}px`}DAW.loopEnabled=!1,DAW.loopStart=0,DAW.loopEnd=4;let loopDragInfo=null;function startDragLoop(e,t){e.stopPropagation(),loopDragInfo={type:t,startX:e.clientX,initStart:DAW.loopStart,initEnd:DAW.loopEnd},document.addEventListener("mousemove",dragLoopLogic),document.addEventListener("mouseup",stopDragLoop)}function dragLoopLogic(e){if(!loopDragInfo)return;let t=(e.clientX-loopDragInfo.startX)/DAW.pixelsPerSecond;if("left"===loopDragInfo.type){let a=loopDragInfo.initStart+t;if(DAW.snap){let n=60/DAW.bpm/4;a=Math.round(a/n)*n}a<0&&(a=0),a>=DAW.loopEnd-.5&&(a=DAW.loopEnd-.5),DAW.loopStart=a}else if("right"===loopDragInfo.type){let i=loopDragInfo.initEnd+t;if(DAW.snap){let r=60/DAW.bpm/4;i=Math.round(i/r)*r}i<=DAW.loopStart+.5&&(i=DAW.loopStart+.5),DAW.loopEnd=i}else if("bar"===loopDragInfo.type){let o=loopDragInfo.initStart+t,l=loopDragInfo.initEnd-loopDragInfo.initStart;if(DAW.snap){let d=60/DAW.bpm/4;o=Math.round(o/d)*d}o<0&&(o=0),DAW.loopStart=o,DAW.loopEnd=o+l}renderLoopUI()}function stopDragLoop(){document.removeEventListener("mousemove",dragLoopLogic),document.removeEventListener("mouseup",stopDragLoop),loopDragInfo=null}function drawVUMeter(){if(requestAnimationFrame(drawVUMeter),!DAW.audioCtx||!DAW.isPlaying)return;let e=document.getElementById("vu-meter-l"),t=document.getElementById("vu-meter-r");if(!e||!t)return;let a=e.getContext("2d"),n=t.getContext("2d");DAW.masterAnalyser.getByteTimeDomainData(DAW.masterDataArray);let i=0;for(let r=0;r<DAW.masterDataArray.length;r++){let o=DAW.masterDataArray[r]/128-1;i+=o*o}let l=Math.sqrt(i/DAW.masterDataArray.length);function d(e,t,a,n){e.clearRect(0,0,t,a);let i=t/20,r=Math.floor(20*n);for(let o=0;o<20;o++)o<r?e.fillStyle=o>=18?"#e11d48":o>=14?"#f59e0b":"#10b981":e.fillStyle="#1e293b",e.fillRect(o*i,0,i-1,a)}d(a,e.width,e.height,Math.min(1,4*l)),d(n,t.width,t.height,Math.min(1,3.8*l))}function reverseRegion(e,t){if(!DAW.audioCtx)return;let a=DAW.tracks.find(t=>t.id===e),n=a.regions.find(e=>e.id===t);if(!n)return;let i=n.buffer,r=DAW.audioCtx.createBuffer(i.numberOfChannels,i.length,i.sampleRate);for(let o=0;o<i.numberOfChannels;o++){let l=new Float32Array(i.getChannelData(o));l.reverse(),r.copyToChannel(l,o)}n.buffer=r,n.startOffset=i.duration-(n.startOffset+n.duration),renderRegions(),saveState()}let nodeDragInfo=null;function startDragNode(e,t,a,n){nodeDragInfo={tId:t,rId:a,nId:n,startX:e.clientX,startY:e.clientY};let i=DAW.tracks.find(e=>e.id===t).regions.find(e=>e.id===a),r=i.automation.find(e=>e.id===n);nodeDragInfo.initT=r.t,nodeDragInfo.initV=r.v,document.addEventListener("mousemove",moveNode),document.addEventListener("mouseup",dropNode)}function moveNode(e){if(!nodeDragInfo)return;let t=(e.clientX-nodeDragInfo.startX)/DAW.pixelsPerSecond,a=e.clientY-nodeDragInfo.startY,n=DAW.tracks.find(e=>e.id===nodeDragInfo.tId).regions.find(e=>e.id===nodeDragInfo.rId),i=n.automation.find(e=>e.id===nodeDragInfo.nId),r=nodeDragInfo.initT+t;r<0&&(r=0),r>n.duration&&(r=n.duration);let o=nodeDragInfo.initV-a/90;o<0&&(o=0),o>1&&(o=1),i.t=r,i.v=o,renderRegions()}function dropNode(){document.removeEventListener("mousemove",moveNode),document.removeEventListener("mouseup",dropNode),nodeDragInfo=null,saveState()}document.getElementById("zoom-slider").addEventListener("input",e=>{DAW.pixelsPerSecond=parseInt(e.target.value),renderTrackLanes(),renderRegions(),renderLoopUI()}),updateGrid();let zoomTimeout;document.getElementById("zoom-slider").addEventListener("input",e=>{DAW.pixelsPerSecond=parseInt(e.target.value),renderTrackLanes(),clearTimeout(zoomTimeout),zoomTimeout=setTimeout(()=>{renderRegions(),updatePlayheadUI()},150)}),document.getElementById("arranger-content").addEventListener("mousedown",()=>{selectedRegionInfo=null,document.querySelectorAll(".audio-region").forEach(e=>e.classList.remove("selected"))}),window.addEventListener("beforeunload",()=>{DAW.audioCtx&&"closed"!==DAW.audioCtx.state&&DAW.audioCtx.close()}),document.body.addEventListener("click",async()=>{DAW.audioCtx&&"suspended"===DAW.audioCtx.state&&await DAW.audioCtx.resume()}),addTrack(),addTrack(),DAW.tracks.length>0&&selectTrack(DAW.tracks[0].id),saveState();